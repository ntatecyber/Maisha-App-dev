<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Maisha Dental Clinics - Simple Dashboard</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

    * { margin:0; padding:0; box-sizing:border-box; }
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
    }
    
    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 300px;
      background: #1e293b;
      padding: 30px 20px;
      border-right: 1px solid #334155;
      overflow-y: auto;
      z-index: 100;
    }
    
    .logo {
      font-size: 22px;
      font-weight: 800;
      color: #60a5fa;
      margin-bottom: 10px; /* Reduced margin to make space for branch name */
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: -0.5px;
    }
    
    /* NEW: Branch Display in Sidebar */
    .branch-display {
        font-size: 14px;
        font-weight: 600;
        color: #94a3b8;
        padding: 0 5px 20px 5px; /* Spacing */
        border-bottom: 1px solid #334155;
        margin-bottom: 25px; /* Spacing before Quick Menu */
    }

    .sidebar-label {
      font-size: 11px;
      color: #94a3b8;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      font-weight: 700;
    }
    
    /* STYLISH BRANCH BUTTONS */
    .branch-btn {
      width: 100%;
      padding: 18px; 
      margin-bottom: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px; 
      font-weight: 700;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 14px;
      background: #283548;
      color: #cbd5e1;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
    }

    .branch-btn:hover {
        transform: translateY(-2px);
        background: #334155;
        color: white;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
    }
    
    .branch-btn.active.silverton { background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%); color: white; border: none; }
    .branch-btn.active.senekal { background: linear-gradient(135deg, #ec4899 0%, #be185d 100%); color: white; border: none; }
    .branch-btn.active.station { background: linear-gradient(135deg, #10b981 0%, #047857 100%); color: white; border: none; }
    
    .quick-menu {
      margin-top: 0; /* Adjusted for branch-display element */
      padding-top: 0;
      border-top: none;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      color: #94a3b8;
      text-decoration: none;
      border-radius: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.22s cubic-bezier(.2,.9,.3,1);
      background: transparent;
    }

    /* modern silk style: subtle hover and glassy active */
    .nav-item:hover { background: rgba(96, 165, 250, 0.06); color: #60a5fa; transform: translateY(-1px); box-shadow: 0 6px 12px rgba(2,6,23,0.06); }
    .nav-item.active { background: linear-gradient(90deg, rgba(59,130,246,1), rgba(79,70,229,1)); color: white; font-weight: 600; box-shadow: 0 6px 18px rgba(59,130,246,0.12); }
    .nav-icon { font-size: 18px; width: 26px; text-align: center; }

    /* slightly refined submenu spacing */
    .nav-group .nav-submenu .nav-item { padding-left: 38px; font-size: 13px; border-radius: 10px; margin-bottom:6px; }

    /* subtle group header caret styling */
    .group-caret { color: #94a3b8; font-size: 12px; margin-left: 8px; }

    /* small table styles for billing */
    .billing-table { width:100%; border-collapse: collapse; font-size: 14px; }
    .billing-table th, .billing-table td { padding: 8px 10px; border-bottom: 1px solid #e6eef8; }
    .billing-table th { text-align: left; color:#334155; font-weight:600; }
    .billing-table tr.editing td { background: rgba(99,102,241,0.03); }

    .btn-mini { padding:6px 8px; font-size:13px; border-radius:8px; }
    .btn-inline { margin-left:6px; }
    
    /* REPORT GROUP STYLING */
    .report-group .nav-item { padding-left: 35px; }

    /* NAV GROUP (submenu) */
    .nav-group .nav-item { display:flex; justify-content:space-between; }
    .nav-group .nav-submenu { display: none; margin-top: 6px; }
    .nav-group.open .nav-submenu { display: block; }
    .nav-group .nav-submenu .nav-item { padding-left: 35px; font-size: 13px; }

    /* TOAST / NOTIFICATION */
    .toast-container { position: fixed; right: 20px; bottom: 20px; z-index: 9999; display:flex; flex-direction:column; gap:8px; }
    .toast { background: #111827; color: #fff; padding: 10px 14px; border-radius: 8px; box-shadow: 0 6px 18px rgba(2,6,23,0.4); opacity: 0.98; min-width: 180px; font-size: 14px; }
    .toast.success { border-left: 4px solid #10b981; }
    .toast.error { border-left: 4px solid #ef4444; }
    .toast .toast-close { margin-left: 8px; cursor: pointer; opacity: 0.8; }


    .main-content {
      margin-left: 300px;
      padding: 40px;
      min-height: 100vh;
    }
    
    .page-title {
      font-size: 32px;
      font-weight: 800;
      color: #f8fafc;
      margin-bottom: 30px;
      letter-spacing: -1px;
    }

    /* REMOVED .breadcrumb STYLES as it's been moved/removed */
    
    .welcome-screen { display: flex; align-items: center; justify-content: center; min-height: 80vh; text-align: center; }
    .welcome-icon { font-size: 80px; margin-bottom: 20px; }
    .welcome-title { font-size: 40px; font-weight: 800; color: #f1f5f9; margin-bottom: 16px; }
    
    /* STYLES FOR SIDE-BY-SIDE BRANCH BUTTONS */
    .main-branch-selector {
        max-width: 900px; 
        margin: 0 auto;
        display: flex; 
        gap: 20px; 
        justify-content: center; 
    }
    .main-branch-selector .branch-btn {
        flex: 1 1 0%; 
        min-width: 150px;
        margin-bottom: 0; 
    }
    /* END NEW STYLES */


    /* DASHBOARD LAYOUT */
    .dashboard-grid { display: flex; flex-direction: column; gap: 30px; }

    .financial-summary-grid, .cash-summary-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-top: 20px;
    }

    /* UNIFIED DARK STAT CARD STYLES (MODERNIZED) */
    .stat-card { 
      background: #1e293b; /* Dark background */
      padding: 24px; 
      border-radius: 16px; /* Slightly tighter radius */
      border: 1px solid transparent; /* Start with transparent border */
      position: relative;
      overflow: hidden;
      transition: all 0.4s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); /* Stronger initial shadow */
      cursor: default; /* Keep card behavior, not button click */
    }

    /* Delicate button hover effect */
    .stat-card:hover { 
        transform: translateY(-4px); 
        border-color: #60a5fa; /* Blue accent border on hover */
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.2), 0 0 10px rgba(59, 130, 246, 0.5); /* Blue glow */
    }

    .stat-label { 
      font-size: 11px; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; font-weight: 700; letter-spacing: 1px;
    }

    /* NEW Color Coding for Stat Values */
    .stat-value { font-size: 32px; font-weight: 800; color: #f8fafc; margin-top: 8px;} /* Change value color to white for contrast, will color individual ones */
    .stat-value.positive { color: #10b981; } /* Green for positive outcome (collected) */
    .stat-value.primary { color: #60a5fa; } /* Blue for primary metrics (charged, locum remuneration) */
    .stat-value.negative { color: #f87171; } /* Red for negative/due (balance, expenses) */
    .stat-value.gold { color: #facc15; } /* Gold for cash/banked */
    /* END MODERNIZED STAT CARD STYLES */


    /* Standard Card & Form Styles */
    .content-card { background: #1e293b; border: 1px solid #334155; border-radius: 20px; padding: 30px; margin-bottom: 30px; }
    .card-title { font-size: 18px; font-weight: 700; color: #f1f5f9; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
    
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .form-group { display: flex; flex-direction: column; }
    .form-label { font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 600; }
    
    .form-input, .form-select, .form-textarea {
      padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 10px; color: #e2e8f0; font-size: 14px;
      width: 100%;
    }
    .form-textarea { min-height: 100px; resize: vertical;}

    
    .btn { padding: 14px 28px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: all 0.3s; font-size: 15px; }
    
    /* Document Selector (Select input styled as a button) - MADE DARKER */
    .btn.btn-primary#documentSelector {
        padding: 14px 18px; 
        background: #1e293b; /* Darker background */
        color: #e2e8f0; /* Lighter text */
        border: 1px solid #334155; /* Subtle border */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); /* Subtle shadow */
        appearance: none; 
        /* Changed arrow color to light gray (#94a3b8) */
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        padding-right: 40px; 
    }
    
    .btn-primary { background: #3b82f6; color: white; box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.39); }
    .btn-upload { background: #10b981; color: white; padding: 10px 15px; }
    
    .table-wrapper { overflow-x: auto; border-radius: 15px; border: 1px solid #334155; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #0f172a; color: #94a3b8; padding: 16px; text-align: left; font-size: 11px; text-transform: uppercase; font-weight: 800; border-bottom: 1px solid #334155; }
    td { padding: 16px; border-bottom: 1px solid #334155; color: #e2e8f0; font-size: 14px; }
    
    .action-btn { padding: 6px 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; margin-right: 5px; }
    .edit-btn { background: #3b82f6; color: white; }
    .delete-btn { background: #ef4444; color: white; }
    
    .hidden { display: none !important; }
    .balance-preview { background: rgba(59, 130, 246, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid rgba(59, 130, 246, 0.2); }

    /* Report Styles */
    .report-table { width: 100%; max-width: 500px; margin-top: 20px; }
    .report-table td { padding: 12px; border-bottom: 1px solid #334155; }
    .report-label { color: #94a3b8; font-weight: 600; }
    .report-value { text-align: right; font-weight: 700; }
    
    .report-total { 
      background: #0f172a; 
      color: #60a5fa; 
      font-weight: 700;
    } 

    /* Appointments Specific */
    .attended-col { width: 80px; text-align: center; }
    .attended-col input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
    
    /* NEW Expense Form Layout */
    .expense-upload-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 5px;
    }
    .expense-upload-group .form-input {
        flex-grow: 1;
    }
    
    /* NEW STYLISH STOCK TABS */
    .stock-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        padding-bottom: 10px;
        border-bottom: 1px solid #334155;
    }
    .stock-tab-btn {
        padding: 10px 18px;
        border: 2px solid transparent;
        border-radius: 10px 10px 0 0;
        background: #0f172a;
        color: #94a3b8;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 15px;
    }
    .stock-tab-btn:hover {
        color: #f1f5f9;
        background: #1e293b;
    }
    .stock-tab-btn.active {
        background: #1e293b;
        color: #60a5fa;
        border-color: #60a5fa;
        border-bottom: 2px solid #1e293b; /* Hide bottom line of border */
    }
    
    .stock-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #334155; }
    .stock-title { font-size: 16px; font-weight: 700; color: #cbd5e1; margin-bottom: 15px; }
    .stock-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #334155; font-size: 14px; }
    .stock-item-name { color: #94a3b8; }
    .stock-item-qty { color: #10b981; font-weight: 600; }

    /* NEW: Dental Chart Styles (Request 4) */
    .dental-chart-container {
        padding: 20px;
        background: #0f172a;
        border-radius: 12px;
    }
    .chart-tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 2px solid #334155;
    }
    .chart-tab-btn {
        padding: 10px 15px;
        cursor: pointer;
        font-weight: 600;
        color: #94a3b8;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
        margin-bottom: -2px; /* Pull up to overlay border */
    }
    .chart-tab-btn.active {
        color: #60a5fa;
        border-bottom: 2px solid #60a5fa;
    }

    .dental-grid {
        display: grid;
        grid-template-columns: repeat(16, 1fr); /* 8 teeth per quadrant, 2 quadrants per arch */
        gap: 5px;
        text-align: center;
        font-size: 12px;
        font-weight: 700;
        margin: 20px 0;
    }

    .tooth-quadrant-header {
        grid-column: span 8;
        color: #94a3b8;
        font-size: 10px;
        text-transform: uppercase;
        padding-bottom: 5px;
        border-bottom: 1px solid #334155;
        margin-bottom: 5px;
    }

    .tooth-item {
        padding: 5px 2px;
        border: 1px solid #334155;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.1s;
        position: relative;
        color: #f1f5f9;
        user-select: none;
    }

    .tooth-item:hover {
        background: #334155;
    }

    .tooth-status {
        position: absolute;
        top: -5px;
        right: -5px;
        font-size: 10px;
        line-height: 1;
        background: #ef4444;
        color: white;
        border-radius: 50%;
        width: 15px;
        height: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    /* END Dental Chart Styles */


    @media (max-width: 1024px) {
      .sidebar { width: 100%; position: relative; height: auto; }
      .main-content { margin-left: 0; }
      .financial-summary-grid, .cash-summary-grid { grid-template-columns: 1fr; }
      .main-branch-selector { flex-direction: column; max-width: 400px; } /* Stack on small screens */
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="logo">ü¶∑ Maisha Clinics</div>
    
    <div id="currentBranchDisplay" class="branch-display hidden"></div>
    
    <div id="loggedInUserDisplay" class="branch-display hidden" style="padding-top: 0; margin-top: -15px;">
        <span style="font-weight: 400;">Logged In:</span> 
        <span id="loggedInUserName" style="color: #60a5fa; font-weight: 700;">N/A</span>
        <p id="currentBranchDate" style="font-size: 11px; font-weight: 400; color: #94a3b8; margin-top: 5px;"></p>
    </div>

    <div id="quickMenu" class="quick-menu hidden">
      <div class="sidebar-label">Quick Menu</div>
      <div class="nav-item active" data-tab="dashboard" onclick="switchTab('dashboard', this, 'üìä Dashboard')">
        <span class="nav-icon">üìä</span> <span>Dashboard</span>
      </div>
      <div class="nav-group" id="billingGroup">
        <div class="nav-item" onclick="toggleNavGroup('billingGroup'); switchTab('add-transaction', document.querySelector('#billingGroup [data-tab=\'add-transaction\']'), 'ÔøΩ Billing Management')">
          <span class="nav-icon">üíº</span> <span>Billing Management</span> <span class="group-caret">‚ñ∏</span>
        </div>
        <div class="nav-submenu">
          <div class="nav-item" data-tab="add-transaction" onclick="switchTab('add-transaction', this, '‚ûï New Transaction')">
            <span class="nav-icon">‚ûï</span> <span>Add Transaction</span>
          </div>
          <div class="nav-item" data-tab="accounts" onclick="switchTab('accounts', this, 'üí∞ Accounts')">
            <span class="nav-icon">üí∞</span> <span>Accounts</span>
          </div> 
        </div>
      </div>
      <div class="nav-group" id="patientManagementGroup">
        <div class="nav-item" onclick="toggleNavGroup('patientManagementGroup'); switchTab('patient-card', document.querySelector('#patientManagementGroup [data-tab=\'patient-card\']'), 'üë• Patient Card')">
          <span class="nav-icon">üóÇÔ∏è</span> <span>Patient Management</span> <span class="group-caret">‚ñ∏</span>
        </div>
        <div class="nav-submenu">
          <div class="nav-item" data-tab="patient-card" onclick="switchTab('patient-card', this, 'üë• Patient Card')">
            <span class="nav-icon">üë•</span> <span>Patient Card</span>
          </div>
          <div class="nav-item" data-tab="new-patient" onclick="switchTab('new-patient', this, 'üÜï New Patient')">
            <span class="nav-icon">üÜï</span> <span>New Patient</span>
          </div>
        </div>
      </div>
      
      <div class="sidebar-label" style="margin-top: 20px;">Financial Reports</div>
      <div class="nav-item" data-tab="daily-report" id="nav-daily-report" onclick="switchTab('daily-report', this, 'üìÑ Daily Report')">
        <span class="nav-icon">üìÑ</span> <span>Daily Report</span>
      </div>
       <div class="nav-item" data-tab="weekly-report" id="nav-weekly-report" onclick="switchTab('weekly-report', this, 'üìÖ Weekly Report')">
        <span class="nav-icon">üìÖ</span> <span>Weekly Report</span>
      </div>
      <div class="nav-item" data-tab="monthly-report" id="nav-monthly-report" onclick="switchTab('monthly-report', this, 'üóìÔ∏è Monthly Report')">
        <span class="nav-icon">üóìÔ∏è</span> <span>Monthly Report</span>
      </div>
      <div class="nav-item" data-tab="quarterly-report" id="nav-quarterly-report" onclick="switchTab('quarterly-report', this, 'üìà Quarterly Report')">
        <span class="nav-icon">üìà</span> <span>Quarterly Report</span>
      </div>
      <div class="nav-item" data-tab="yearly-report" id="nav-yearly-report" onclick="switchTab('yearly-report', this, 'üëë Yearly Report')">
        <span class="nav-icon">üëë</span> <span>Yearly Report</span>
      </div>
      
      <div class="sidebar-label" style="margin-top: 20px;">Operations</div>
      <div class="nav-item" data-tab="queue-management" onclick="switchTab('queue-management', this, '‚è≥ Queue Management')">
        <span class="nav-icon">‚è≥</span> <span>Queue Management</span>
      </div>
      <div class="nav-item" data-tab="locum" id="nav-locum-summary" onclick="switchTab('locum', this, 'üí∞ Locum Summary')">
        <span class="nav-icon">üí∞</span> <span>Locum Summary</span>
      </div>
      <div class="nav-item" data-tab="daily-expense" onclick="switchTab('daily-expense', this, 'üí∏ Daily Expenses')">
        <span class="nav-icon">üí∏</span> <span>Daily Expenses</span>
      </div>
      <div class="nav-item" data-tab="appointments" onclick="switchTab('appointments', this, '‚è±Ô∏è Appointments')">
        <span class="nav-icon">‚è±Ô∏è</span> <span>Appointments</span>
      </div>
      <div class="nav-item" data-tab="stock" onclick="switchTab('stock', this, 'üì¶ Stock Management')">
        <span class="nav-icon">üì¶</span> <span>Stock Management</span>
      </div>
      
    </div>
  </div>

  <div class="main-content">
    
    <div id="welcomeScreen" class="welcome-screen">
      <div class="welcome-content">
        <div class="welcome-icon">üè•</div>
        <h1 class="welcome-title">Maisha Dental Clinics</h1>
        <p style="color: #94a3b8; font-size: 18px; margin-bottom: 35px;">Select a branch to begin managing transactions</p>
        
        <div class="main-branch-selector">
          <button class="branch-btn silverton" onclick="selectBranch('Silverton', this)">
            <span>üè•</span> <span>Silverton</span>
          </button>
          <button class="branch-btn senekal" onclick="selectBranch('Senekal', this)">
            <span>üè•</span> <span>Senekal</span>
          </button>
          <button class="branch-btn station" onclick="selectBranch('Station Medical', this)">
            <span>üè•</span> <span>Station Medical Centre</span>
          </button>
        </div>
      </div>
    </div>
    
    <div id="loginScreen" class="welcome-screen hidden">
        <div class="welcome-content" style="max-width: 400px; padding: 40px; background: #1e293b; border-radius: 20px; border: 1px solid #334155;">
            <h2 class="welcome-title" style="font-size: 28px;">Branch Access: <span id="loginBranchName" style="color: #60a5fa;"></span></h2>
            <p style="color: #94a3b8; margin-bottom: 30px;">Please enter your credentials to access the dashboard.</p>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label" for="username">Username</label>
                <input type="text" class="form-input" id="username" placeholder="Enter username" autocomplete="username" onkeypress="if(event.key==='Enter') document.getElementById('password').focus()">
            </div>
            <div class="form-group" style="margin-bottom: 30px;">
                <label class="form-label" for="password">Password</label>
                <input type="password" class="form-input" id="password" placeholder="Enter your password" autocomplete="current-password" onkeypress="if(event.key==='Enter') login()">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="login()">üîë Log In</button>
        </div>
    </div>

    <div id="branchContainer" class="hidden">
      <h1 class="page-title" id="viewTitle">üìä Dashboard</h1>

      <div id="tab-dashboard" class="tab-content">
        <div class="dashboard-grid">
          
          <div class="financial-summary-grid">
             <div class="stat-card">
              <div class="stat-label">Total Charged (Today)</div>
              <div class="stat-value primary" id="stat-charged">R 0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Collected (Today)</div>
              <div class="stat-value positive" id="stat-collected">R 0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Patient Balance Due (History)</div>
              <div class="stat-value negative" id="stat-balance">R 0</div>
            </div>
          </div>
          
          <div class="financial-summary-grid">
            <div class="stat-card">
              <div class="stat-label">Locum Remuneration (Today - 50% of Net Collected)</div>
              <div class="stat-value primary" id="stat-locum">R 0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Locum Balance Due (50% of Patient Balance)</div>
              <div class="stat-value negative" id="stat-locum-balance">R 0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Lab Fees Total Incurred (Today)</div>
              <div class="stat-value primary" id="stat-lab-total">R 0</div>
            </div>
          </div>

          <div class="cash-summary-grid">
            <div class="stat-card">
                <div class="stat-label">Total Banked (Today's Net Deposit)</div>
                <div class="stat-value gold" id="stat-banked">R 0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Daily Outflows (Locum, Lab Paid, Expenses, Kitty)</div>
                <div class="stat-value negative" id="stat-expenses">R 0</div>
            </div>
             <div class="stat-card">
              <div class="stat-label">Lab Balance Outstanding (History)</div>
              <div class="stat-value negative" id="stat-lab-balance">R 0</div>
            </div>
          </div>

          <!-- NEW: Waiting in Line Section -->
          <div style="margin-top: 30px; border-top: 2px solid #334155; padding-top: 20px;">
            <h3 class="card-title" style="margin-bottom: 15px;">‚è≥ Patients Waiting in Line</h3>
            <div id="waitingListContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;">
              <p style="color: #94a3b8; grid-column: 1/-1;">No patients waiting.</p>
            </div>
          </div>
          
        </div>
      </div>

      <div id="tab-add-transaction" class="tab-content hidden">
        <div class="content-card">
            <h2 class="card-title" id="formTitle">‚ûï New Transaction</h2>
            <div class="form-grid">
              <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="date"></div>
              <div class="form-group"><label class="form-label">Doctor *</label><select class="form-select" id="doctor"><option>M. Mokoma</option><option>M. Lepele</option></select></div>
              
              <div class="form-group"><label class="form-label">Patient Name *</label><input type="text" class="form-input" id="patientName" list="patientDatalist"></div>
              <div class="form-group"><label class="form-label">Cell Number</label><input type="text" class="form-input" id="cellNumber"></div>
              
              <datalist id="patientDatalist"></datalist>
              <div class="form-group">
                  <label class="form-label">Procedure *</label>
                  <select class="form-select" id="procedure" onchange="updateProcedureFee()">
                      <option value="">-- Select Procedure --</option>
                      <optgroup label="GENERAL DENTISTRY">
                          <option value="Consultation">Consultation</option>
                          <option value="Extraction">Extraction</option>
                          <option value="Composite Restoration">Filling (Composite Restoration)</option>
                          <option value="Filling (Amalgam)">Filling (Amalgam) - R600</option>
                          <option value="Scaling and Polishing">Scaling and Polishing</option>
                          <option value="Whitening">Whitening (Bleaching)</option>
                          <option value="Root Planning">Root Planning</option>
                          <option value="Sensitive Treat Rx">Sensitive Treat Rx</option>
                          <option value="Sliming Wires">Sliming Wires</option>
                          <option value="Bite Block (Weight Loss)">Bite Block (Weight Loss)</option>
                          <option value="Fibre Bridge">Fibre Bridge</option>
                          <option value="Maryland Bridge">Maryland Bridge</option>
                          <option value="Inlays">Inlays</option>
                          <option value="Zirconia Crowns 1">Zirconia Crown</option>
                      </optgroup>
                      <optgroup label="DENTURES">
                          <option value="Full Mouth Denture">Full Mouth Denture</option>
                          <option value="Full Upper/Lower Denture">Full Upper/Lower Denture</option>
                          <option value="Denture Repair">Denture Repair</option>
                          <option value="Denture Cleaning">Denture Cleaning</option>
                          <option value="1 Tooth Denture">1 Tooth Denture</option>
                          <option value="2 Teeth Denture">2 Teeth Denture</option>
                          <option value="3 Teeth Denture">3 Teeth Denture</option>
                          <option value="4 Teeth Denture">4 Teeth Denture</option>
                          <option value="5-6 Teeth Denture">5-6 Teeth Denture</option>
                          <option value="7-8 Teeth Denture">7-8 Teeth Denture</option>
                          <option value="9 or More Teeth Denture">9 or More Teeth Denture</option>
                      </optgroup>
                  </select>
              </div>
              
              <div class="form-group" style="grid-column: span 1;">
                  <label class="form-label">Tooth # / Quantity *</label>
                  <div style="display: flex; gap: 10px;">
                      <input type="text" class="form-input" id="toothNumbers" placeholder="e.g., 16, 21-23" style="flex-basis: 70%;">
                      <select class="form-select" id="quantity" style="flex-basis: 30%;">
                           <option value="1">1</option>
                           <option value="2">2</option>
                           <option value="3">3</option>
                           <option value="4">4</option>
                           <option value="5">5</option>
                           <option value="6">6</option>
                           <option value="7">7</option>
                           <option value="8">8</option>
                           <option value="9">9</option>
                           <option value="10">10</option>
                      </select>
                  </div>
              </div>

              <div class="form-group"><label class="form-label">Fee</label><input type="number" class="form-input" id="procedureFee"></div>
              <div class="form-group">
                <label class="form-label">Payment Method *</label>
                <select class="form-select" id="paymentMethod" onchange="handlePaymentMethodChange()">
                    <option value="Cash">Cash</option>
                    <option value="EFT">EFT</option>
                    <option value="Medical Aid">Medical Aid</option>
                </select>
              </div>
              <div class="form-group"><label class="form-label">Paid</label><input type="number" class="form-input" id="amountPaid" value="0"></div>
              <div class="form-group"><label class="form-label">Lab Fees</label><input type="number" class="form-input" id="labFees" value="0"></div>
              <div class="form-group"><label class="form-label">Lab Paid</label><input type="number" class="form-input" id="labFeesPaid" value="0"></div>
            </div>
             <div class="form-group" style="grid-column: span 2; margin-bottom: 25px;"><label class="form-label">Treatment Notes</label><textarea class="form-textarea" id="treatmentNotes"></textarea></div>

            <div class="balance-preview"><div class="form-label">Calculated Patient Balance Due</div><div id="balancePreview" style="color: #60a5fa; font-size: 24px; font-weight: 800;">R 0</div></div>
            <button class="btn btn-primary" id="submitBtn" onclick="addTransaction()">üíæ Save Transaction</button>
        </div>
      </div>

      <div id="tab-patient-card" class="tab-content hidden">
        <div class="content-card" style="display: flex; gap: 30px; min-height: 70vh;">
            <div style="flex-basis: 30%; border-right: 1px solid #334155; padding-right: 20px;">
                <h3 class="card-title" style="margin-bottom: 15px;">üë§ Patient Search</h3>
                <div class="form-group" style="margin-bottom: 15px;">
                    <input type="text" class="form-input" id="patientSearchInput" placeholder="Search Patient Name..." onkeyup="renderUniquePatientList()">
                </div>
                <div id="uniquePatientList" style="overflow-y: auto; max-height: 50vh;">
                    <p style="text-align: center; color: #94a3b8; padding-top: 15px;">Start searching for a patient.</p>
                </div>
            </div>
            
            <div id="patientDetailsView" style="flex-basis: 70%;">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                    <h3 class="card-title" id="patientCardHeader">Select a Patient to View Details</h3>
                    <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
                        <button class="btn" id="editPatientBtn" onclick="startEditPatient()" style="display:none; padding:6px 10px;">‚úèÔ∏è Edit</button>
                        <button class="btn" id="deletePatientBtn" onclick="deletePatient()" style="display:none; background:#ef4444; color:white; padding:6px 10px;">üóëÔ∏è Delete</button>
                        <button class="btn" id="toggleHistoryBtn" onclick="togglePatientHistory()" style="display:none; padding:6px 10px;">üìú History</button>
                    </div>
                </div>
                <p id="patientCardPhone" style="color: #94a3b8; margin-bottom: 8px;">History and details will appear here.</p>
                <p id="patientCardAddress" style="color: #94a3b8; margin-bottom: 20px; display:none;"></p>
                
                <div class="content-card dental-chart-container" style="padding: 20px; border: none;">
                    <div class="chart-tabs">
                        <div class="chart-tab-btn active" onclick="switchChartTab('chart', this)">Dental Chart</div>
                        <div class="chart-tab-btn" onclick="switchChartTab('details', this)">Selected Tooth Details</div>
                    </div>
                    
                    <div id="chart-tab-chart" class="chart-tab-content">
                         <h4 style="color: #60a5fa; margin-bottom: 10px;">Permanent Dentition (18-48)</h4>
                         <div class="dental-grid">
                            <div class="tooth-quadrant-header">Right Maxillary (1)</div>
                            <div class="tooth-quadrant-header">Left Maxillary (2)</div>
                            <div class="tooth-item">18<div class="tooth-status hidden" data-tooth="18">X</div></div>
                            <div class="tooth-item">17<div class="tooth-status hidden" data-tooth="17">X</div></div>
                            <div class="tooth-item">16<div class="tooth-status hidden" data-tooth="16">X</div></div>
                            <div class="tooth-item">15<div class="tooth-status hidden" data-tooth="15">X</div></div>
                            <div class="tooth-item">14<div class="tooth-status hidden" data-tooth="14">X</div></div>
                            <div class="tooth-item">13<div class="tooth-status hidden" data-tooth="13">X</div></div>
                            <div class="tooth-item">12<div class="tooth-status hidden" data-tooth="12">X</div></div>
                            <div class="tooth-item">11<div class="tooth-status hidden" data-tooth="11">X</div></div>
                            <div class="tooth-item">21<div class="tooth-status hidden" data-tooth="21">X</div></div>
                            <div class="tooth-item">22<div class="tooth-status hidden" data-tooth="22">X</div></div>
                            <div class="tooth-item">23<div class="tooth-status hidden" data-tooth="23">X</div></div>
                            <div class="tooth-item">24<div class="tooth-status hidden" data-tooth="24">X</div></div>
                            <div class="tooth-item">25<div class="tooth-status hidden" data-tooth="25">X</div></div>
                            <div class="tooth-item">26<div class="tooth-status hidden" data-tooth="26">X</div></div>
                            <div class="tooth-item">27<div class="tooth-status hidden" data-tooth="27">X</div></div>
                            <div class="tooth-item">28<div class="tooth-status hidden" data-tooth="28">X</div></div>
                         </div>
                         <div class="dental-grid">
                            <div class="tooth-quadrant-header">Right Mandibular (4)</div>
                            <div class="tooth-quadrant-header">Left Mandibular (3)</div>
                            <div class="tooth-item">48<div class="tooth-status hidden" data-tooth="48">X</div></div>
                            <div class="tooth-item">47<div class="tooth-status hidden" data-tooth="47">X</div></div>
                            <div class="tooth-item">46<div class="tooth-status hidden" data-tooth="46">X</div></div>
                            <div class="tooth-item">45<div class="tooth-status hidden" data-tooth="45">X</div></div>
                            <div class="tooth-item">44<div class="tooth-status hidden" data-tooth="44">X</div></div>
                            <div class="tooth-item">43<div class="tooth-status hidden" data-tooth="43">X</div></div>
                            <div class="tooth-item">42<div class="tooth-status hidden" data-tooth="42">X</div></div>
                            <div class="tooth-item">41<div class="tooth-status hidden" data-tooth="41">X</div></div>
                            <div class="tooth-item">31<div class="tooth-status hidden" data-tooth="31">X</div></div>
                            <div class="tooth-item">32<div class="tooth-status hidden" data-tooth="32">X</div></div>
                            <div class="tooth-item">33<div class="tooth-status hidden" data-tooth="33">X</div></div>
                            <div class="tooth-item">34<div class="tooth-status hidden" data-tooth="34">X</div></div>
                            <div class="tooth-item">35<div class="tooth-status hidden" data-tooth="35">X</div></div>
                            <div class="tooth-item">36<div class="tooth-status hidden" data-tooth="36">X</div></div>
                            <div class="tooth-item">37<div class="tooth-status hidden" data-tooth="37">X</div></div>
                            <div class="tooth-item">38<div class="tooth-status hidden" data-tooth="38">X</div></div>
                         </div>
                         <h4 style="color: #60a5fa; margin-top: 20px; margin-bottom: 10px;">Deciduous Dentition (55-85)</h4>
                         <div class="dental-grid" style="grid-template-columns: repeat(10, 1fr); max-width: 600px; margin-left: auto; margin-right: auto;">
                            <div class="tooth-quadrant-header" style="grid-column: span 5;">Right Maxillary (5)</div>
                            <div class="tooth-quadrant-header" style="grid-column: span 5;">Left Maxillary (6)</div>
                            <div class="tooth-item">55<div class="tooth-status hidden" data-tooth="55">X</div></div>
                            <div class="tooth-item">54<div class="tooth-status hidden" data-tooth="54">X</div></div>
                            <div class="tooth-item">53<div class="tooth-status hidden" data-tooth="53">X</div></div>
                            <div class="tooth-item">52<div class="tooth-status hidden" data-tooth="52">X</div></div>
                            <div class="tooth-item">51<div class="tooth-status hidden" data-tooth="51">X</div></div>
                            <div class="tooth-item">61<div class="tooth-status hidden" data-tooth="61">X</div></div>
                            <div class="tooth-item">62<div class="tooth-status hidden" data-tooth="62">X</div></div>
                            <div class="tooth-item">63<div class="tooth-status hidden" data-tooth="63">X</div></div>
                            <div class="tooth-item">64<div class="tooth-status hidden" data-tooth="64">X</div></div>
                            <div class="tooth-item">65<div class="tooth-status hidden" data-tooth="65">X</div></div>
                         </div>
                         <div class="dental-grid" style="grid-template-columns: repeat(10, 1fr); max-width: 600px; margin-left: auto; margin-right: auto; margin-bottom: 0;">
                            <div class="tooth-quadrant-header" style="grid-column: span 5;">Right Mandibular (8)</div>
                            <div class="tooth-quadrant-header" style="grid-column: span 5;">Left Mandibular (7)</div>
                            <div class="tooth-item">85<div class="tooth-status hidden" data-tooth="85">X</div></div>
                            <div class="tooth-item">84<div class="tooth-status hidden" data-tooth="84">X</div></div>
                            <div class="tooth-item">83<div class="tooth-status hidden" data-tooth="83">X</div></div>
                            <div class="tooth-item">82<div class="tooth-status hidden" data-tooth="82">X</div></div>
                            <div class="tooth-item">81<div class="tooth-status hidden" data-tooth="81">X</div></div>
                            <div class="tooth-item">71<div class="tooth-status hidden" data-tooth="71">X</div></div>
                            <div class="tooth-item">72<div class="tooth-status hidden" data-tooth="72">X</div></div>
                            <div class="tooth-item">73<div class="tooth-status hidden" data-tooth="73">X</div></div>
                            <div class="tooth-item">74<div class="tooth-status hidden" data-tooth="74">X</div></div>
                            <div class="tooth-item">75<div class="tooth-status hidden" data-tooth="75">X</div></div>
                         </div>
                    </div>

                    <div id="chart-tab-details" class="chart-tab-content hidden">
                        <h3 class="card-title" id="selectedToothHeader">Select a Tooth from the Chart</h3>
                        <div id="toothDetailsContent">
                            <p style="color: #94a3b8;">Click on a tooth above to see and modify its status.</p>
                        </div>

                        <div id="toothModificationForm" class="content-card hidden" style="background: #0f172a; border: 1px solid #334155; margin-top: 20px;">
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="toothStatus">
                                        <option value="">No Status</option>
                                        <option value="Missing">Missing (X)</option>
                                        <option value="Carious">Carious (C)</option>
                                        <option value="Filled">Filled (F)</option>
                                        <option value="Crown">Crown (Cr)</option>
                                        <option value="Root Canal">Root Canal (RC)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Notes</label>
                                    <input type="text" class="form-input" id="toothNotes">
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="saveToothStatus()">üíæ Save Tooth Status</button>
                        </div>
                    </div>
                </div>

                <h3 class="card-title" style="margin-top: 40px; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 20px;">Treatment Record</h3>
                <p style="color: #94a3b8; font-size: 12px; margin-bottom: 12px;">üìù View treatment history with billing details in Accounts menu.</p>
                <div class="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th>Date</th> <th>Doctor</th> <th>Procedure</th> <th>Tooth # / Qty</th> <th>Notes</th>
                      </tr>
                    </thead>
                    <tbody id="patientHistoryTableBody">
                      <tr><td colspan="5" style="text-align: center; color: #94a3b8;">Select a patient to load history.</td></tr>
                    </tbody>
                  </table>
                </div>

                <h3 class="card-title" style="margin-top: 40px; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 20px;">Reports/Documents</h3>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label class="form-label">Select Document Type</label>
                        <select class="btn btn-primary" id="documentSelector" onchange="handleDocumentSelection(this.value)">
                            <option value="">-- Select Report Type --</option>
                            <option value="history">Full Treatment History</option>
                            <option value="medical-certificate">Medical Certificate</option>
                            <option value="prescription">üíä Prescription</option>
                        </select>
                    </div>
                    <div class="form-group" style="align-items: flex-end;">
                        <button class="btn btn-primary" id="previewBtn" onclick="previewDocument()" disabled>üìÑ Preview Document</button>
                    </div>
                </div>
                <pre id="documentPreviewArea" class="content-card hidden" style="background: #0f172a; white-space: pre-wrap; margin-top: 15px;"></pre>



                <!-- NEW: Medical Prescription Section -->
                <h3 class="card-title" style="margin-top: 40px; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 20px;">üíä Medical Prescription</h3>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div class="form-group">
                        <label class="form-label">Medication Name *</label>
                        <select class="form-select" id="prescriptionMedicationName" onchange="updatePrescriptionDefaults()">
                            <option value="">-- Select Medication --</option>
                            <option value="Amoxicillin">Amoxil (Amoxicillin)</option>
                            <option value="Erythromycin">Erythromycin</option>
                            <option value="Metronidozole">Metronidozole</option>
                            <option value="Panado">Panado (Paracetamol)</option>
                            <option value="Brufen">Brufen (Ibuprofen)</option>
                            <option value="Myprodol">Myprodol</option>
                            <option value="Dolorol">Dolorol</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dosage *</label>
                        <select class="form-select" id="prescriptionDosage">
                            <option value="">-- Select Dosage --</option>
                            <!-- Amoxil / Amoxicillin -->
                            <option value="250mg">250 mg</option>
                            <option value="500mg">500 mg</option>
                            <!-- Erythromycin capsules -->
                            <option value="250mg_ery">250 mg (erythro)</option>
                            <option value="500mg_ery">500 mg (erythro)</option>
                            <!-- Suspensions -->
                            <option value="125mg/5ml">125 mg / 5 ml (susp)</option>
                            <option value="250mg/5ml">250 mg / 5 ml (susp)</option>
                            <!-- Metronidozole -->
                            <option value="200mg">200 mg</option>
                            <option value="400mg">400 mg</option>
                            <!-- Brufen -->
                            <option value="200mg_brufen">200 mg</option>
                            <option value="400mg_brufen">400 mg</option>
                        </select>
                        <div id="pediatricDosageHint" style="color:#94a3b8; font-size:12px; margin-top:6px;">Pediatric guidance will appear here when applicable.</div>
                        <div id="pediatricDosageTable" style="color:#9ae6b4; font-size:12px; margin-top:6px; display:none;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Frequency *</label>
                        <select class="form-select" id="prescriptionFrequency">
                            <option value="">-- Select --</option>
                            <option value="Once daily">Once daily</option>
                            <option value="Twice daily">Twice daily</option>
                            <option value="Three times a day">Three times a day</option>
                            <option value="Thrice daily">Thrice daily</option>
                            <option value="Four times daily">Four times daily</option>
                            <option value="Every 8 hrs">Every 8 hrs</option>
                            <option value="As needed">As needed</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Patient Weight (kg) - optional</label><input type="number" min="0" step="0.1" id="prescriptionPatientWeight" class="form-input" placeholder="e.g., 15.5" oninput="computePediatricDose()"></div>
                    <div class="form-group">
                        <label class="form-label">Duration *</label>
                        <input type="text" class="form-input" id="prescriptionDuration" placeholder="e.g., 7 days, 2 weeks">
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="form-label">Special Instructions</label>
                        <textarea class="form-textarea" id="prescriptionInstructions" placeholder="e.g., Take with food, avoid dairy" style="min-height: 60px;"></textarea>
                    </div>
                </div>
                <div style="display: flex; gap: 6px; margin-bottom: 12px; align-items:center;">
                    <button class="btn btn-primary" style="padding:6px 8px; font-size:13px;" onclick="addPrescription()">üíæ Add Prescription</button>
                    <button class="btn" style="padding:6px 8px; font-size:13px;" onclick="previewPrescription()">üìÑ Preview</button>
                </div>
                <div id="prescriptionListContainer" style="margin-top: 15px;">
                    <div style="color: #94a3b8; font-size: 12px;">No prescriptions yet.</div>
                </div>
            </div>
        </div>
      </div>

      <div id="tab-new-patient" class="tab-content hidden">
        <div class="content-card" style="max-width: 700px;">
          <h3 class="card-title">üÜï New Patient</h3>
          <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <input type="hidden" id="newPatientId">
            <div class="form-group"><label class="form-label">First Name *</label><input type="text" class="form-input" id="newPatientFirstName" autocomplete="given-name"></div>
            <div class="form-group"><label class="form-label">Surname *</label><input type="text" class="form-input" id="newPatientSurname" autocomplete="family-name"></div>
            <div class="form-group"><label class="form-label">Cell Number *</label><input type="text" class="form-input" id="newPatientCell" autocomplete="tel" onblur="formatNewPatientPhone()" oninput="this.value=this.value.replace(/[^0-9+\s]/g,'')"></div>
            <div class="form-group"><label class="form-label">Date of Birth</label><input type="date" class="form-input" id="newPatientDOB" autocomplete="bday" title="Optional - used for pediatric dosing"></div>
            <div class="form-group" style="grid-column: span 2;"><label class="form-label">Physical Address</label><input type="text" class="form-input" id="newPatientAddress" autocomplete="street-address"></div>
          </div>
          <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" onclick="saveNewPatient()">üíæ Save Patient</button>
            <button class="btn" onclick="clearNewPatientForm()">‚úñ Clear</button>
          </div>
        </div>
      </div>

      <div id="tab-locum" class="tab-content hidden">
        <div class="content-card">
          <h2 class="card-title">üí∞ Locum Summary</h2>
          <div class="form-group" style="max-width: 300px;">
            <label class="form-label">Select Doctor</label>
            <select class="form-select" id="locumDoctor" onchange="updateLocumSummary(); populateLocumPaymentAmount()">
              <option value="All">All Doctors</option>
              <option>M. Mokoma</option>
              <option>M. Lepele</option>
            </select>
          </div>

          <!-- Minimal period selector for quick totals -->
          <div style="display:flex; gap:12px; align-items:flex-end; margin-top: 12px;">
              <div class="form-group" style="margin-bottom:0;">
                  <label class="form-label">Period</label>
                  <select id="locumPeriod" class="form-select" onchange="updateLocumSummary()">
                      <option value="daily">Daily</option>
                      <option value="weekly">Weekly</option>
                      <option value="monthly">Monthly</option>
                      <option value="all">All Time</option>
                  </select>
              </div>
              <div class="form-group" style="margin-bottom:0;">
                  <label class="form-label">Date</label>
                  <input type="date" id="locumPeriodDate" class="form-input" onchange="updateLocumSummary()">
              </div>
              <div style="display:flex; align-items:center; gap:8px;">
                  <button class="btn" style="height:38px;" onclick="updateLocumSummary()">Refresh</button>
                  <button class="btn" style="height:38px;" onclick="runLocumSmokeTest()">Validate</button>
              </div>
          </div>

          <div id="locumSummaryOutput" style="margin-top: 18px; display:flex; gap:12px; align-items:flex-start;">
            <div id="locumPeriodSummary" style="flex:1; min-width:280px;">
              <div style="color: var(--muted);">Summary for selected period:</div>
              <div style="display:flex; gap:10px; margin-top:8px;">
                  <div class="stat-card" style="flex:1; padding:12px;">
                      <div class="stat-label">Total Collected</div>
                      <div class="stat-value" id="locum-total-collected">R 0</div>
                  </div>
                  <div class="stat-card" style="flex:1; padding:12px;">
                      <div class="stat-label">Net Collection</div>
                      <div class="stat-value" id="locum-net-collection">R 0</div>
                  </div>
              </div>
              <div style="display:flex; gap:10px; margin-top:8px;">
                  <div class="stat-card" style="flex:1; padding:12px;">
                      <div class="stat-label">Locum Fee (50%)</div>
                      <div class="stat-value" id="locum-fee-period">R 0</div>
                  </div>
                  <div class="stat-card" style="flex:1; padding:12px;">
                      <div class="stat-label">Paid (Period)</div>
                      <div class="stat-value" id="locum-paid-period">R 0</div>
                  </div>
              </div>
              <div style="margin-top:10px;">
                  <div class="stat-label">Balance (Period)</div>
                  <div class="stat-value" id="locum-balance-period">R 0</div>
              </div>
            </div>
            <div style="min-width:260px;">
                <div style="color: var(--muted);">History balance:</div>
                <div class="stat-card" style="margin-top:8px; padding:12px;">
                    <div class="stat-label">TOTAL AMOUNT DUE TO LOCUM (History Balance)</div>
                    <div class="stat-value negative" id="locum-balance-due" style="font-size: 32px;">R 0</div>
                </div>
            </div>
          </div>

          <h3 class="card-title" style="margin-top: 30px; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 20px;">Log Locum Payment</h3>
          <div id="locumPaymentLogSection" class="content-card" style="background: #0f172a; padding: 20px; border: 1px solid #334155;">
              <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                  <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="locumPaymentDate"></div>
                  <div class="form-group"><label class="form-label">Doctor</label><select class="form-select" id="locumPaymentDoctor" onchange="populateLocumPaymentAmount()"><option>M. Mokoma</option><option>M. Lepele</option></select></div>
              </div>
              <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                  <div class="form-group"><label class="form-label">Amount Paid (Auto-populates to Total Due)</label><input type="number" class="form-input" id="locumPaymentAmount"></div>
                  <div class="form-group" style="grid-column: span 2;"><label class="form-label">Notes</label><input type="text" class="form-input" id="locumPaymentNotes"></div>
              </div>
              <button class="btn btn-upload" style="margin-top: 15px;" onclick="logLocumPayment()">üí∏ Log Payment</button>
          </div>

          <h3 class="card-title" style="margin-top: 30px; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 20px;">Payment History</h3>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>ID</th> <th>Date</th> <th>Doctor</th> <th>Amount (R)</th> <th>Notes</th> <th>Actions</th>
                </tr>
              </thead>
              <tbody id="locumPaymentTableBody">
                <tr><td colspan="6" style="text-align: center; color: #94a3b8;">Select a doctor to load history.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="tab-daily-expense" class="tab-content hidden">
        <div class="content-card">
          <h2 class="card-title">üí∏ Log Daily Expense</h2>
          <div id="expenseLogSection" class="content-card" style="background: #0f172a; padding: 20px; border: 1px solid #334155; margin-bottom: 30px;">
              <div class="form-grid">
                  <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="expenseDate"></div>
                  <div class="form-group"><label class="form-label">Item/Service *</label><input type="text" class="form-input" id="expenseItem"></div>
                  <div class="form-group"><label class="form-label">Cost (R) *</label><input type="number" class="form-input" id="expenseCost"></div>
                  <div class="form-group"><label class="form-label">Doctor/Staff (Logged By)</label><select class="form-select" id="expenseDoctor"><option>Admin</option><option>M. Mokoma</option><option>M. Lepele</option><option>Alina</option></select></div>
              </div>
              <div class="form-group" style="margin-top: 15px;">
                  <label class="form-label">Receipt Link (Optional)</label>
                  <div class="expense-upload-group">
                      <input type="text" class="form-input" id="expenseReceiptLink" placeholder="e.g., Google Drive link">
                  </div>
              </div>
              <button class="btn btn-upload" style="margin-top: 15px;" onclick="addDailyExpense()">üìù Log Expense</button>
          </div>

          <h3 class="card-title" style="border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 20px;">Expense History</h3>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>ID</th> <th>Date</th> <th>Item</th> <th>Cost (R)</th> <th>Logged By</th> <th>Receipt</th> <th>Actions</th>
                </tr>
              </thead>
              <tbody id="expenseTableBody">
                <tr><td colspan="7" style="text-align: center; color: #94a3b8;">No expenses logged for this branch.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div id="tab-appointments" class="tab-content hidden">
        <div class="content-card">
          <h2 class="card-title">‚è±Ô∏è Appointments</h2>
          <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
              <div class="form-group"><label class="form-label">Doctor</label><select class="form-select" id="apptDoctor"><option>M. Mokoma</option><option>M. Lepele</option></select></div>
              <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="apptDate" onchange="renderAppointments()"></div>
          </div>

          <h3 class="card-title" style="font-size: 18px; margin-top: 30px;">New Appointment</h3>
          <div class="form-grid">
              <div class="form-group"><label class="form-label">Time</label><input type="time" class="form-input" id="apptTime"></div>
              <div class="form-group"><label class="form-label">Patient Name *</label><input type="text" class="form-input" id="apptPatientName"></div>
              <div class="form-group"><label class="form-label">Cell Number</label><input type="text" class="form-input" id="apptCellNumber"></div>
              <div class="form-group"><label class="form-label">Notes</label><input type="text" class="form-input" id="apptNotes"></div>
          </div>
          <button class="btn btn-primary" style="margin-top: 15px;" onclick="addAppointment()">üìÖ Schedule Appointment</button>

          <h3 class="card-title" style="border-bottom: 1px solid #334155; padding-bottom: 10px; margin-top: 40px; margin-bottom: 20px;">Appointments List</h3>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Time</th> <th>Patient Name</th> <th>Cell Number</th> <th>Doctor</th> <th>Notes</th> <th>Attended</th> <th>Actions</th>
                </tr>
              </thead>
              <tbody id="appointmentsTableBody">
                <tr><td colspan="7" style="text-align: center; color: #94a3b8;">Select a date to load appointments.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- NEW: Queue Management Tab -->
      <div id="tab-queue-management" class="tab-content hidden">
        <div class="content-card">
          <h2 class="card-title">‚è≥ Queue Management</h2>
          <p style="color: #94a3b8; margin-bottom: 15px;">View and manage patients waiting for treatment. Propose treatments and track patient progress.</p>
          
          <div style="display: flex; gap: 12px; margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="switchQueueTab('waiting', this)">üë• Waiting Patients</button>
            <button class="btn" onclick="switchQueueTab('in-treatment', this)">‚öïÔ∏è In Treatment</button>
            <button class="btn" onclick="switchQueueTab('completed', this)">‚úÖ Completed</button>
          </div>

          <div id="queue-waiting-section" class="queue-tab-content">
            <div id="waitingPatientsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
              <p style="color: #94a3b8; grid-column: 1/-1;">No patients waiting.</p>
            </div>
          </div>

          <div id="queue-in-treatment-section" class="queue-tab-content hidden">
            <div id="treatmentPatientsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
              <p style="color: #94a3b8; grid-column: 1/-1;">No patients in treatment.</p>
            </div>
          </div>

          <div id="queue-completed-section" class="queue-tab-content hidden">
            <div id="completedPatientsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
              <p style="color: #94a3b8; grid-column: 1/-1;">No completed treatments.</p>
            </div>
          </div>
        </div>
      </div>

      <div id="tab-stock" class="tab-content hidden">
        <div class="content-card">
          <h2 class="card-title">üì¶ Stock Management</h2>
          
          <div class="stock-tabs">
            <div class="stock-tab-btn active" onclick="switchStockTab('items', this)">Current Inventory</div>
            <div class="stock-tab-btn" onclick="switchStockTab('log', this)">Stock Log/History</div>
          </div>
          
          <div id="stock-items-section" class="stock-tab-content">
            <h3 class="card-title" style="margin-bottom: 15px;">Stock Count</h3>
            <div id="stockInventoryList">
                <p style="color: #94a3b8;">Inventory will load here.</p>
            </div>
            
            <h3 class="card-title" style="margin-top: 40px; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 20px;">Log Stock Movement (In/Out)</h3>
             <div id="stockLogSection" class="content-card" style="background: #0f172a; padding: 20px; border: 1px solid #334155;">
                  <div class="form-grid">
                      <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="stockDate"></div>
                      <div class="form-group"><label class="form-label">Item Name *</label><input type="text" class="form-input" id="stockItemName"></div>
                      <div class="form-group"><label class="form-label">Type *</label><select class="form-select" id="stockType"><option value="In">Stock In (Addition)</option><option value="Out">Stock Out (Usage/Waste)</option></select></div>
                      <div class="form-group"><label class="form-label">Quantity *</label><input type="number" class="form-input" id="stockQuantity"></div>
                      <div class="form-group"><label class="form-label">Total Cost (for 'Stock In')</label><input type="number" class="form-input" id="stockTotalCost"></div>
                      <div class="form-group"><label class="form-label">Notes</label><input type="text" class="form-input" id="stockNotes"></div>
                  </div>
                  <button class="btn btn-primary" style="margin-top: 15px;" onclick="logStockMovement()">üìù Log Movement</button>
             </div>
          </div>

          <div id="stock-log-section" class="stock-tab-content hidden">
             <h3 class="card-title" style="margin-top: 15px; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 20px;">Movement History</h3>
             <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th> <th>Item</th> <th>Type</th> <th>Quantity</th> <th>Cost (R)</th> <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody id="stockLogTableBody">
                    <tr><td colspan="6" style="text-align: center; color: #94a3b8;">Stock movement history will load here.</td></tr>
                  </tbody>
                </table>
              </div>
          </div>
        </div>
      </div>
      
      <div id="tab-daily-report" class="tab-content hidden">
          <div class="content-card">
              <h2 class="card-title">üìÑ Daily Report</h2>
              <div class="form-group" style="max-width: 300px; margin-bottom: 30px;">
                  <label class="form-label">Select Date</label>
                  <input type="date" class="form-input" id="dailyReportDate" onchange="generateReport('daily')">
              </div>
              <div id="dailyReportOutput"></div>
          </div>
      </div>

      <div id="tab-weekly-report" class="tab-content hidden">
          <div class="content-card">
              <h2 class="card-title">üìÖ Weekly Report</h2>
              <div class="form-group" style="max-width: 300px; margin-bottom: 30px;">
                  <label class="form-label">Select Week Start Date</label>
                  <input type="date" class="form-input" id="weeklyReportDate" onchange="generateReport('weekly')">
              </div>
              <div id="weeklyReportOutput"></div>
          </div>
      </div>

      <div id="tab-monthly-report" class="tab-content hidden">
          <div class="content-card">
              <h2 class="card-title">üóìÔ∏è Monthly Report</h2>
              <div class="form-group" style="max-width: 300px; margin-bottom: 30px;">
                  <label class="form-label">Select Month</label>
                  <input type="month" class="form-input" id="monthlyReportDate" onchange="generateReport('monthly')">
              </div>
              <div id="monthlyReportOutput"></div>
          </div>
      </div>
      
      <div id="tab-quarterly-report" class="tab-content hidden">
          <div class="content-card">
              <h2 class="card-title">üìà Quarterly Report</h2>
              <div class="form-group" style="max-width: 300px; margin-bottom: 30px;">
                  <label class="form-label">Select Quarter Start (Jan, Apr, Jul, Oct)</label>
                  <input type="date" class="form-input" id="quarterlyReportDate" onchange="generateReport('quarterly')">
              </div>
              <div id="quarterlyReportOutput"></div>
          </div>
      </div>
      
      <div id="tab-yearly-report" class="tab-content hidden">
          <div class="content-card">
              <h2 class="card-title">üëë Yearly Report</h2>
              <div class="form-group" style="max-width: 300px; margin-bottom: 30px;">
                  <label class="form-label">Select Year</label>
                  <input type="number" class="form-input" id="yearlyReportDate" onchange="generateReport('yearly')" min="2023" max="2100" step="1">
              </div>
              <div id="yearlyReportOutput"></div>
          </div>
      </div>

      <!-- NEW: Billing sub-tabs -->
      <!-- NEW: Accounts Tab -->
      <div id="tab-accounts" class="tab-content hidden">
        <div class="content-card">
          <h2 class="card-title">üí∞ Accounts - Patient Transactions</h2>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; margin-bottom: 15px;">
            <div class="form-group" style="margin-bottom: 0;">
              <label class="form-label" style="font-size: 12px;">Patient Name</label>
              <input type="text" class="form-input" id="accountsPatientFilter" placeholder="Search patient..." onkeyup="renderAccountsTransactions()">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label class="form-label" style="font-size: 12px;">Doctor</label>
              <select class="form-select" id="accountsDoctorFilter" onchange="renderAccountsTransactions()">
                <option value="">All Doctors</option>
                <option>M. Mokoma</option>
                <option>M. Lepele</option>
              </select>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label class="form-label" style="font-size: 12px;">From Date</label>
              <input type="date" class="form-input" id="accountsFromDate" onchange="renderAccountsTransactions()">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label class="form-label" style="font-size: 12px;">To Date</label>
              <input type="date" class="form-input" id="accountsToDate" onchange="renderAccountsTransactions()">
            </div>
          </div>
          <div style="margin-bottom: 12px; display:flex; align-items:center; gap:12px;">
            <button class="btn btn-primary" id="accountsViewStatementBtn" onclick="previewAccountsStatement()">View Statement</button>
            <div style="color:#94a3b8; font-size:12px;">Enter full patient name in the Patient filter then click to view their Account Statement.</div>
            <div id="accountsMatchedHint" style="color:#60a5fa; font-size:12px; margin-left:10px;"></div>
          </div>
          <div id="accountsSummary" style="margin-bottom: 15px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
            <div class="stat-card">
              <div class="stat-label">Total Charged</div>
              <div class="stat-value primary" id="accounts-stat-charged">R 0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Collected</div>
              <div class="stat-value positive" id="accounts-stat-collected">R 0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Outstanding Balance</div>
              <div class="stat-value negative" id="accounts-stat-balance">R 0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Lab Fees Due</div>
              <div class="stat-value" id="accounts-stat-lab" style="color: #f59e0b;">R 0</div>
            </div>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Date</th> <th>Doctor</th> <th>Patient</th> <th>Procedure</th> <th>Fee (R)</th> <th>Paid (R)</th> <th>Balance (R)</th> <th>Lab Fees (R)</th> <th>Lab Paid (R)</th>
                </tr>
              </thead>
              <tbody id="accountsTransactionsTable">
                <tr><td colspan="9" style="text-align: center; color: #94a3b8;">Select filters to view transactions.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>


    </div>
      <!-- Toast container (created dynamically if not present) -->
      <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>
    </div>
  </div>

  <script>
    // --- GLOBAL STATE ---
    let currentBranch = null;
    let currentUser = null;
    let allTransactions = [];
    let allExpenses = [];
    let allLocumPayments = []; // NEW: Array to store locum payments
    let allAppointments = [];
    let allPatients = []; // Stored patient records (created via New Patient form)
    let allWaitingTickets = []; // NEW: Waiting in line tickets (created when new patient added)
    let allPrescriptions = []; // NEW: Medical prescriptions per patient
    let dentalChartStatus = {};
    let allStockLog = [];
    let selectedPatientName = null;
    let selectedTooth = null;
    let lastDeletedPatient = null;
    let lastDeletedTimeout = null;
    let nextTicketNumber = 1000; // NEW: Ticket number counter

    const locumFeePercentage = 0.50; // 50% locum fee
    
    // Default Doctor/Staff Options
    const defaultDoctorOptions = '<option>M. Mokoma</option><option>M. Lepele</option>';
    const defaultExpenseOptions = '<option>Admin</option><option>M. Mokoma</option><option>M. Lepele</option><option>Alina</option>';
    
    // User Roles/Credentials
    // NOTE: Passwords are intentionally left empty to avoid storing plaintext credentials in the source file.
    // If you want to enable password checks for a local/dev environment, populate the password field and
    // the login() function below will validate it. Empty passwords allow login by username only (demo mode).
    const users = [
        { username: 'user', password: '', role: 'Admin', doctorName: 'Admin' },
        { username: 'Mokomam', password: '', role: 'Doctor', doctorName: 'M. Mokoma' },
        { username: 'Lepelem', password: '', role: 'Doctor', doctorName: 'M. Lepele' },
        { username: 'Alina', password: '', role: 'Assistance', doctorName: 'Alina' }
    ];

    // --- UTILITIES ---
    function formatCurrency(amount) {
        if (typeof amount !== 'number') return `R 0.00`;
        return `R ${amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, " ")}`;
    }

    function todayDateString() {
        return new Date().toISOString().split('T')[0];
    }

    // --- PHONE UTILITIES ---
    function normalizePhoneDigits(s) {
        if (!s) return '';
        const digits = (s + '').replace(/\D/g, '');
        if (!digits) return '';
        if (digits.length === 10 && digits.startsWith('0')) return digits; // 0712345678
        if (digits.length === 11 && digits.startsWith('27')) return '0' + digits.slice(2); // 27712345678 -> 0712345678
        if (digits.length === 12 && digits.startsWith('0027')) return '0' + digits.slice(3); // 0027712345678 -> 0712345678
        return '';
    }

    function formatPhoneDisplay(normalized) {
        if (!normalized) return '';
        if (normalized.length === 10) return normalized.replace(/(\d{3})(\d{3})(\d{4})/, '$1 $2 $3');
        return normalized;
    }

    function safeFormatPhone(raw) {
        const n = normalizePhoneDigits(raw);
        return n ? formatPhoneDisplay(n) : (raw || '');
    }

    function formatNewPatientPhone() {
        const el = document.getElementById('newPatientCell');
        if (!el) return;
        const n = normalizePhoneDigits(el.value);
        if (n) el.value = formatPhoneDisplay(n);
    }

    // Simple toast notifications for in-app feedback
    function showToast(message, type = 'success', duration = 2500) {
        let container = document.getElementById('toastContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container';
            document.body.appendChild(container);
        }

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;

        const close = document.createElement('span');
        close.className = 'toast-close';
        close.textContent = '‚úñ';
        close.style.marginLeft = '8px';
        close.onclick = () => { toast.remove(); };

        toast.appendChild(close);
        container.appendChild(toast);

        setTimeout(() => {
            try { toast.remove(); } catch (e) {}
        }, duration);
    }
    
    function startOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Monday start
        const start = new Date(d.setDate(diff));
        return start.toISOString().split('T')[0];
    }

    function startOfQuarter(date) {
        const d = new Date(date);
        const month = d.getMonth();
        let quarterStartMonth;
        if (month >= 0 && month <= 2) quarterStartMonth = 0; // Jan
        else if (month >= 3 && month <= 5) quarterStartMonth = 3; // Apr
        else if (month >= 6 && month <= 8) quarterStartMonth = 6; // Jul
        else quarterStartMonth = 9; // Oct
        
        d.setMonth(quarterStartMonth, 1);
        return d.toISOString().split('T')[0];
    }

    // --- DATA HANDLING ---
    function loadData() {
        allTransactions = JSON.parse(localStorage.getItem('allTransactions')) || [];
        allExpenses = JSON.parse(localStorage.getItem('allExpenses')) || [];
        allLocumPayments = JSON.parse(localStorage.getItem('allLocumPayments')) || [];
        allAppointments = JSON.parse(localStorage.getItem('allAppointments')) || [];
        allPatients = JSON.parse(localStorage.getItem('allPatients')) || [];
        allWaitingTickets = JSON.parse(localStorage.getItem('allWaitingTickets')) || []; // NEW: Load waiting tickets
        allPrescriptions = JSON.parse(localStorage.getItem('allPrescriptions')) || []; // NEW: Load prescriptions
        dentalChartStatus = JSON.parse(localStorage.getItem('dentalChartStatus')) || {};
        allStockLog = JSON.parse(localStorage.getItem('allStockLog')) || [];

        // Expose key runtime arrays to `window` so headless tests can access them reliably
        try {
            window.allPatients = allPatients;
            window.allTransactions = allTransactions;
            window.allExpenses = allExpenses;
            window.allLocumPayments = allLocumPayments;
            window.allWaitingTickets = allWaitingTickets; // NEW: Expose waiting tickets
            window.allPrescriptions = allPrescriptions; // NEW: Expose prescriptions
        } catch (e) {
            // If `window` isn't writable in some environments, ignore the exposure step
        }
        
        // Load branch and user from session storage
        currentBranch = sessionStorage.getItem('currentBranch');
        const userData = sessionStorage.getItem('currentUser');
        if (userData) {
            currentUser = JSON.parse(userData);
        }

        if (currentBranch && currentUser) {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('branchContainer').classList.remove('hidden');
            document.getElementById('quickMenu').classList.remove('hidden');
            document.getElementById('loggedInUserDisplay').classList.remove('hidden');
            document.getElementById('currentBranchDisplay').classList.remove('hidden');
            document.getElementById('currentBranchDisplay').textContent = `Branch: ${currentBranch}`;
            document.getElementById('loggedInUserName').textContent = `${currentUser.doctorName} (${currentUser.role})`;
            document.getElementById('currentBranchDate').textContent = `Today: ${todayDateString()}`;
            applyRoleRestrictions(currentUser.role, currentUser.doctorName);
            updateDashboard();
            switchTab('dashboard', document.querySelector('.nav-item[data-tab="dashboard"]'));
            // Initial call for datalist
            renderPatientDatalist(); 
        } else {
             document.getElementById('welcomeScreen').classList.remove('hidden');
        }
    }

    function saveData() {
        localStorage.setItem('allTransactions', JSON.stringify(allTransactions));
        localStorage.setItem('allExpenses', JSON.stringify(allExpenses));
        localStorage.setItem('allLocumPayments', JSON.stringify(allLocumPayments));
        localStorage.setItem('allAppointments', JSON.stringify(allAppointments));
        localStorage.setItem('allPatients', JSON.stringify(allPatients));
        localStorage.setItem('allWaitingTickets', JSON.stringify(allWaitingTickets)); // NEW: Save waiting tickets
        localStorage.setItem('allPrescriptions', JSON.stringify(allPrescriptions)); // NEW: Save prescriptions
        localStorage.setItem('dentalChartStatus', JSON.stringify(dentalChartStatus));
        localStorage.setItem('allStockLog', JSON.stringify(allStockLog));
        
        sessionStorage.setItem('currentBranch', currentBranch);
        sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
    }

    // --- CORE LOGIC ---
    function getTodayFinancials() {
        if (!currentBranch) return {};
        const todayDate = todayDateString();
        
        const transactions = allTransactions.filter(t => t.branch === currentBranch && t.date === todayDate);
        
        const totalCharged = transactions.reduce((sum, t) => sum + t.procedureFee, 0);
        const totalCollected = transactions.reduce((sum, t) => sum + t.amountPaid, 0);
        const totalPatientBalance = allTransactions.filter(t => t.branch === currentBranch).reduce((sum, t) => sum + (t.procedureFee - t.amountPaid), 0);
        const totalLabFees = transactions.reduce((sum, t) => sum + t.labFees, 0);
        const totalLabPaid = transactions.reduce((sum, t) => sum + t.labFeesPaid, 0);

        // Calculate Locum Remuneration based on NET collection (Collection - Lab Paid)
        const netCollection = totalCollected - totalLabPaid;
        const locumRemuneration = netCollection > 0 ? netCollection * locumFeePercentage : 0;
        
        // Locum Balance Due is their cut of the patient balance remaining
        const totalLocumBalanceDue = totalPatientBalance > 0 ? totalPatientBalance * locumFeePercentage : 0;
        
        // Calculate Expenses & Outflows for Banking Summary
        const todayExpenses = allExpenses.filter(e => e.branch === currentBranch && e.date === todayDate);
        const totalDailyExpenses = todayExpenses.reduce((sum, e) => sum + e.cost, 0);
        
        // Outflows now include the Locum Remuneration (which is their cut of *today's* net collection) and Lab Paid
        const totalOutflows = locumRemuneration + totalLabPaid + totalDailyExpenses; // Kitty is not tracked here
        
        const totalBanked = totalCollected - totalOutflows;
        
        const labBalanceOutstanding = allTransactions.filter(t => t.branch === currentBranch).reduce((sum, t) => sum + (t.labFees - t.labFeesPaid), 0);

        return {
            totalCharged,
            totalCollected,
            totalPatientBalance,
            locumRemuneration,
            totalLocumBalanceDue,
            totalLabFees,
            totalLabPaid,
            totalDailyExpenses,
            totalOutflows,
            totalBanked,
            labBalanceOutstanding
        };
    }

    function updateDashboard() {
        const stats = getTodayFinancials();
        
        document.getElementById('stat-charged').textContent = formatCurrency(stats.totalCharged);
        document.getElementById('stat-collected').textContent = formatCurrency(stats.totalCollected);
        document.getElementById('stat-balance').textContent = formatCurrency(stats.totalPatientBalance);
        document.getElementById('stat-locum').textContent = formatCurrency(stats.locumRemuneration);
        document.getElementById('stat-locum-balance').textContent = formatCurrency(stats.totalLocumBalanceDue);
        document.getElementById('stat-lab-total').textContent = formatCurrency(stats.totalLabFees);
        document.getElementById('stat-banked').textContent = formatCurrency(stats.totalBanked);
        document.getElementById('stat-expenses').textContent = formatCurrency(stats.totalOutflows);
        document.getElementById('stat-lab-balance').textContent = formatCurrency(stats.labBalanceOutstanding);
        
        // NEW: Update waiting list display
        renderWaitingListDashboard();
    }

    // NEW: Render waiting list on dashboard
    function renderWaitingListDashboard() {
        const container = document.getElementById('waitingListContainer');
        if (!container) return;
        
        const waitingTickets = (allWaitingTickets || []).filter(t => t.status === 'waiting');
        
        if (waitingTickets.length === 0) {
            container.innerHTML = '<p style="color: #94a3b8; grid-column: 1/-1;">No patients waiting.</p>';
            return;
        }
        
        container.innerHTML = waitingTickets.map((ticket, idx) => `
            <div class="content-card" style="padding: 12px; border: 1px solid #475569; cursor: pointer;" onclick="openWaitingTicketDetail(${ticket.id})">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="font-weight: 700; color: #60a5fa;">Ticket #${ticket.ticketNumber}</div>
                    <div style="font-size: 12px; color: #94a3b8;">${new Date(ticket.createdAt).toLocaleTimeString()}</div>
                </div>
                <div style="color: #e2e8f0; font-size: 14px; margin-bottom: 4px;">${escapeHtml(ticket.patientName)}</div>
                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 8px;">${escapeHtml(ticket.cellNumber)}</div>
                <div style="background: #1e293b; padding: 8px; border-radius: 4px; font-size: 12px; color: #cbd5e1;">${escapeHtml(ticket.proposedTreatment || 'No treatment proposed yet')}</div>
            </div>
        `).join('');
    }

    // NEW: Open waiting ticket detail for management
    function openWaitingTicketDetail(ticketId) {
        const ticket = allWaitingTickets.find(t => t.id === ticketId);
        if (!ticket) {
            showToast('Ticket not found.', 'error');
            return;
        }
        // Could switch to a detail view or open a modal; for now, just show a toast with basic info
        showToast(`Ticket #${ticket.ticketNumber}: ${ticket.patientName} - ${ticket.proposedTreatment || 'No treatment yet'}`);
    }

    // NEW: Switch queue tab view
    function switchQueueTab(tabName, btnElement) {
        document.querySelectorAll('.queue-tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.btn-group button, [onclick*="switchQueueTab"]').forEach(el => el.classList.remove('active'));
        
        if (tabName === 'waiting') {
            document.getElementById('queue-waiting-section').classList.remove('hidden');
            renderWaitingQueuePatients();
        } else if (tabName === 'in-treatment') {
            document.getElementById('queue-in-treatment-section').classList.remove('hidden');
            renderInTreatmentQueuePatients();
        } else if (tabName === 'completed') {
            document.getElementById('queue-completed-section').classList.remove('hidden');
            renderCompletedQueuePatients();
        }
        
        btnElement.classList.add('active');
    }

    // NEW: Render waiting queue patients for doctor/assistant view
    function renderWaitingQueuePatients() {
        const container = document.getElementById('waitingPatientsContainer');
        if (!container) return;
        
        const tickets = (allWaitingTickets || []).filter(t => t.status === 'waiting');
        
        if (tickets.length === 0) {
            container.innerHTML = '<p style="color: #94a3b8; grid-column: 1/-1;">No patients waiting.</p>';
            return;
        }
        
        container.innerHTML = tickets.map(ticket => `
            <div class="content-card" style="border: 2px solid #475569; padding: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <div style="font-weight: 700; font-size: 18px; color: #60a5fa;">Ticket #${ticket.ticketNumber}</div>
                    <button class="btn" style="padding: 4px 8px; font-size: 12px;" onclick="removeWaitingTicket(${ticket.id})">‚ùå Cancel</button>
                </div>
                <div style="color: #e2e8f0; font-weight: 500; margin-bottom: 6px;">${escapeHtml(ticket.patientName)}</div>
                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 10px;">üì± ${escapeHtml(ticket.cellNumber)}</div>
                <div style="background: #1e293b; padding: 8px; border-radius: 4px; margin-bottom: 10px; min-height: 30px;">
                    <input type="text" class="form-input" id="treatment_${ticket.id}" placeholder="Proposed treatment (e.g., Consultation, Extraction)" value="${escapeHtml(ticket.proposedTreatment || '')}" style="width: 100%; margin-bottom: 6px; background: #0f172a; border-color: #334155; padding: 6px; border-radius: 3px;">
                    <div style="display: flex; gap: 6px;">
                        <button class="btn btn-primary" style="flex: 1; padding: 6px; font-size: 12px;" onclick="proposeTreatment(${ticket.id})">üíä Propose Treatment</button>
                        <button class="btn" style="flex: 1; padding: 6px; font-size: 12px;" onclick="startTreatment(${ticket.id})">‚ñ∂Ô∏è Start Treatment</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // NEW: Propose treatment for a patient
    function proposeTreatment(ticketId) {
        const ticket = allWaitingTickets.find(t => t.id === ticketId);
        if (!ticket) {
            showToast('Ticket not found.', 'error');
            return;
        }
        
        const proposedText = (document.getElementById(`treatment_${ticketId}`) || {}).value || '';
        if (!proposedText.trim()) {
            showToast('Please enter a treatment proposal.', 'error');
            return;
        }
        
        ticket.proposedTreatment = proposedText.trim();
        saveData();
        renderWaitingQueuePatients();
        showToast(`Treatment proposed for Ticket #${ticket.ticketNumber}`);
    }

    // NEW: Start treatment (move to in-treatment status)
    function startTreatment(ticketId) {
        const ticket = allWaitingTickets.find(t => t.id === ticketId);
        if (!ticket) {
            showToast('Ticket not found.', 'error');
            return;
        }
        
        ticket.status = 'in-treatment';
        ticket.treatments = ticket.treatments || [];
        ticket.treatments.push({
            startedAt: new Date().toISOString(),
            doctor: (currentUser && currentUser.doctorName) ? currentUser.doctorName : 'Unknown',
            notes: ''
        });
        saveData();
        renderWaitingQueuePatients();
        renderInTreatmentQueuePatients();
        showToast(`Treatment started for Ticket #${ticket.ticketNumber}`);
    }

    // NEW: Render in-treatment queue patients
    function renderInTreatmentQueuePatients() {
        const container = document.getElementById('treatmentPatientsContainer');
        if (!container) return;
        
        const tickets = (allWaitingTickets || []).filter(t => t.status === 'in-treatment');
        
        if (tickets.length === 0) {
            container.innerHTML = '<p style="color: #94a3b8; grid-column: 1/-1;">No patients in treatment.</p>';
            return;
        }
        
        container.innerHTML = tickets.map(ticket => {
            const lastTx = (ticket.treatments && ticket.treatments.length > 0) ? ticket.treatments[ticket.treatments.length - 1] : null;
            return `
            <div class="content-card" style="border: 2px solid #f59e0b; padding: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <div style="font-weight: 700; font-size: 18px; color: #fbbf24;">‚öïÔ∏è Ticket #${ticket.ticketNumber}</div>
                    <button class="btn" style="padding: 4px 8px; font-size: 12px;" onclick="removeWaitingTicket(${ticket.id})">‚ùå Cancel</button>
                </div>
                <div style="color: #e2e8f0; font-weight: 500; margin-bottom: 6px;">${escapeHtml(ticket.patientName)}</div>
                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 6px;">üì± ${escapeHtml(ticket.cellNumber)}</div>
                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 10px;">Proposed: ${escapeHtml(ticket.proposedTreatment || 'N/A')}</div>
                ${lastTx ? `<div style="color: #94a3b8; font-size: 11px; margin-bottom: 10px;">Started by: ${escapeHtml(lastTx.doctor)} at ${new Date(lastTx.startedAt).toLocaleTimeString()}</div>` : ''}
                <div style="background: #1e293b; padding: 8px; border-radius: 4px; margin-bottom: 10px;">
                    <textarea class="form-textarea" id="notes_${ticket.id}" placeholder="Add treatment notes..." style="width: 100%; background: #0f172a; border-color: #334155; color: #e2e8f0; padding: 6px; min-height: 50px; border-radius: 3px;">${lastTx && lastTx.notes ? escapeHtml(lastTx.notes) : ''}</textarea>
                    <div style="display: flex; gap: 6px; margin-top: 8px;">
                        <button class="btn btn-primary" style="flex: 1; padding: 6px; font-size: 12px;" onclick="updateTreatmentNotes(${ticket.id})">üíæ Save Notes</button>
                        <button class="btn" style="flex: 1; padding: 6px; font-size: 12px; background: #10b981; color: white;" onclick="completeTreatment(${ticket.id})">‚úÖ Complete</button>
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }

    // NEW: Update treatment notes
    function updateTreatmentNotes(ticketId) {
        const ticket = allWaitingTickets.find(t => t.id === ticketId);
        if (!ticket || !ticket.treatments || ticket.treatments.length === 0) {
            showToast('No treatment record found.', 'error');
            return;
        }
        
        const notes = (document.getElementById(`notes_${ticketId}`) || {}).value || '';
        ticket.treatments[ticket.treatments.length - 1].notes = notes;
        saveData();
        showToast('Treatment notes saved.');
    }

    // NEW: Complete treatment
    function completeTreatment(ticketId) {
        const ticket = allWaitingTickets.find(t => t.id === ticketId);
        if (!ticket) {
            showToast('Ticket not found.', 'error');
            return;
        }
        
        ticket.status = 'completed';
        ticket.completedAt = new Date().toISOString();
        saveData();
        renderInTreatmentQueuePatients();
        renderCompletedQueuePatients();
        showToast(`Treatment completed for Ticket #${ticket.ticketNumber}`);
    }

    // NEW: Render completed queue patients
    function renderCompletedQueuePatients() {
        const container = document.getElementById('completedPatientsContainer');
        if (!container) return;
        
        const tickets = (allWaitingTickets || []).filter(t => t.status === 'completed');
        
        if (tickets.length === 0) {
            container.innerHTML = '<p style="color: #94a3b8; grid-column: 1/-1;">No completed treatments.</p>';
            return;
        }
        
        container.innerHTML = tickets.map(ticket => `
            <div class="content-card" style="border: 2px solid #10b981; padding: 15px; opacity: 0.8;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <div style="font-weight: 700; font-size: 16px; color: #10b981;">‚úÖ Ticket #${ticket.ticketNumber}</div>
                    <button class="btn" style="padding: 4px 8px; font-size: 12px;" onclick="removeWaitingTicket(${ticket.id})">üóëÔ∏è Remove</button>
                </div>
                <div style="color: #e2e8f0; font-weight: 500; margin-bottom: 6px;">${escapeHtml(ticket.patientName)}</div>
                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 6px;">üì± ${escapeHtml(ticket.cellNumber)}</div>
                <div style="color: #94a3b8; font-size: 12px;">Completed: ${new Date(ticket.completedAt).toLocaleString()}</div>
            </div>
        `).join('');
    }

    // NEW: Remove waiting ticket
    function removeWaitingTicket(ticketId) {
        const idx = allWaitingTickets.findIndex(t => t.id === ticketId);
        if (idx === -1) {
            showToast('Ticket not found.', 'error');
            return;
        }
        
        const removed = allWaitingTickets.splice(idx, 1)[0];
        saveData();
        renderWaitingQueuePatients();
        renderInTreatmentQueuePatients();
        renderCompletedQueuePatients();
        renderWaitingListDashboard();
        showToast(`Ticket #${removed.ticketNumber} removed.`);
    }
    
    // --- TRANSACTION HANDLING ---
    function updateProcedureFee() {
        const procedure = document.getElementById('procedure').value;
        let fee = 0;
        switch (procedure) {
            case 'Consultation': fee = 450; break;
            case 'Extraction': fee = 900; break;
            case 'Composite Restoration': fee = 850; break;
            case 'Filling (Amalgam)': fee = 600; break;
            case 'Scaling and Polishing': fee = 800; break;
            case 'Whitening': fee = 2500; break;
            case 'Root Planning': fee = 1000; break;
            case 'Sensitive Treat Rx': fee = 400; break;
            case 'Sliming Wires': fee = 5000; break;
            case 'Bite Block (Weight Loss)': fee = 8000; break;
            case 'Fibre Bridge': fee = 3000; break;
            case 'Maryland Bridge': fee = 3500; break;
            case 'Inlays': fee = 550; break;
            case 'Zirconia Crowns 1': fee = 3800; break;
            case 'Full Mouth Denture': fee = 9000; break;
            case 'Full Upper/Lower Denture': fee = 5000; break;
            case 'Denture Repair': fee = 800; break;
            case 'Denture Cleaning': fee = 350; break;
            case '1 Tooth Denture': fee = 1200; break;
            case '2 Teeth Denture': fee = 1500; break;
            case '3 Teeth Denture': fee = 1800; break;
            case '4 Teeth Denture': fee = 2100; break;
            case '5-6 Teeth Denture': fee = 2500; break;
            case '7-8 Teeth Denture': fee = 3000; break;
            case '9 or More Teeth Denture': fee = 4500; break;
        }
        
        // Multiplier for quantity
        const quantity = parseInt(document.getElementById('quantity').value) || 1;
        fee = fee * quantity;

        document.getElementById('procedureFee').value = fee.toFixed(2);
        updateBalancePreview();
    }
    
    function updateBalancePreview() {
        const fee = parseFloat(document.getElementById('procedureFee').value) || 0;
        const paid = parseFloat(document.getElementById('amountPaid').value) || 0;
        const balance = fee - paid;
        
        const balanceElement = document.getElementById('balancePreview');
        balanceElement.textContent = formatCurrency(balance);
        
        // Apply color coding
        if (balance > 0) {
            balanceElement.style.color = '#f87171'; // Red for outstanding balance
        } else if (balance < 0) {
            balanceElement.style.color = '#10b981'; // Green for overpaid/credit
        } else {
            balanceElement.style.color = '#60a5fa'; // Blue for balanced
        }
    }

    function handlePaymentMethodChange() {
        const method = document.getElementById('paymentMethod').value;
        const paidInput = document.getElementById('amountPaid');
        const fee = parseFloat(document.getElementById('procedureFee').value) || 0;
        
        // If Medical Aid is selected, auto-fill paid amount to the full fee
        if (method === 'Medical Aid') {
            paidInput.value = fee.toFixed(2);
            paidInput.disabled = false; // Allow modification
        } else {
            // Clear or reset to 0 for other methods, user will input
            paidInput.value = (fee > 0 ? fee.toFixed(2) : '0.00'); // Default to full fee to prevent accidental missed input
            paidInput.disabled = false;
        }
        updateBalancePreview();
    }

    function addTransaction() {
        const date = document.getElementById('date').value;
        const doctor = document.getElementById('doctor').value;
        const patientName = document.getElementById('patientName').value.trim();
        const cellNumber = document.getElementById('cellNumber').value.trim();
        const procedure = document.getElementById('procedure').value;
        const toothNumbers = document.getElementById('toothNumbers').value.trim();
        const quantity = parseInt(document.getElementById('quantity').value) || 1;
        const procedureFee = parseFloat(document.getElementById('procedureFee').value) || 0;
        const paymentMethod = document.getElementById('paymentMethod').value;
        const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
        const labFees = parseFloat(document.getElementById('labFees').value) || 0;
        const labFeesPaid = parseFloat(document.getElementById('labFeesPaid').value) || 0;
        const treatmentNotes = document.getElementById('treatmentNotes').value.trim();
        
        if (!date || !doctor || !patientName || !procedure) {
            alert('Please fill in all required fields (Date, Doctor, Patient Name, Procedure).');
            return;
        }
        
        if (procedureFee < 0 || amountPaid < 0 || labFees < 0 || labFeesPaid < 0) {
            alert('Fees and amounts cannot be negative.');
            return;
        }
        
        const balance = procedureFee - amountPaid;

        allTransactions.push({
            id: Date.now(),
            branch: currentBranch,
            date,
            doctor,
            patientName,
            cellNumber,
            procedure,
            toothNumbers,
            quantity,
            procedureFee,
            paymentMethod,
            amountPaid,
            labFees,
            labFeesPaid,
            treatmentNotes,
            balance
        });
        saveData();
        alert('Transaction saved successfully.');
        
        // Reset form for new entry
        document.getElementById('patientName').value = '';
        document.getElementById('cellNumber').value = '';
        document.getElementById('procedure').value = '';
        document.getElementById('toothNumbers').value = '';
        document.getElementById('quantity').value = '1';
        document.getElementById('procedureFee').value = '';
        document.getElementById('paymentMethod').value = 'Cash';
        document.getElementById('amountPaid').value = '0';
        document.getElementById('labFees').value = '0';
        document.getElementById('labFeesPaid').value = '0';
        document.getElementById('treatmentNotes').value = '';
        updateBalancePreview();
        updateDashboard();
        renderPatientDatalist(); // Re-render datalist after new transaction
    }
    
    // --- EXPENSES ---
    function addDailyExpense() {
        const date = document.getElementById('expenseDate').value;
        const item = document.getElementById('expenseItem').value.trim();
        const cost = parseFloat(document.getElementById('expenseCost').value) || 0;
        const doctor = document.getElementById('expenseDoctor').value;
        const receiptLink = document.getElementById('expenseReceiptLink').value.trim();

        if (!date || !item || cost <= 0) {
            alert('Please fill in all required fields (Date, Item/Service, Cost > 0).');
            return;
        }

        allExpenses.push({
            id: Date.now(),
            branch: currentBranch,
            date,
            item,
            cost,
            doctor,
            receiptLink
        });
        saveData();
        alert(`Expense for ${item} logged successfully: ${formatCurrency(cost)}.`);

        // Reset form (keep date and doctor)
        document.getElementById('expenseItem').value = '';
        document.getElementById('expenseCost').value = '';
        document.getElementById('expenseReceiptLink').value = '';
        renderExpenseLog();
        updateDashboard();
    }
    
    function renderExpenseLog() {
        const branchExpenses = allExpenses.filter(e => e.branch === currentBranch)
            .sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort newest first

        const tableBody = document.getElementById('expenseTableBody');
        if (branchExpenses.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #94a3b8;">No expenses logged for this branch.</td></tr>';
            return;
        }
        
        const isDoctor = currentUser.role === 'Doctor';

        tableBody.innerHTML = branchExpenses.map(e => {
            const receiptHtml = e.receiptLink ? `<a href="${e.receiptLink}" target="_blank">üîó View</a>` : '-';
            const costText = `<span style="color: #ef4444;">${formatCurrency(e.cost)}</span>`;
            
            // Only Admin and the Doctor who logged it can delete
            const canDelete = currentUser.role === 'Admin' || (isDoctor && currentUser.doctorName === e.doctor);
            const actionHtml = canDelete ? `<button class="action-btn delete-btn" onclick="deleteExpense(${e.id})">üóëÔ∏è Delete</button>` : 'üîí';

            return `
                <tr>
                    <td>${e.id}</td>
                    <td>${e.date}</td>
                    <td>${e.item}</td>
                    <td>${costText}</td>
                    <td>${e.doctor}</td>
                    <td>${receiptHtml}</td>
                    <td>${actionHtml}</td>
                </tr>
            `;
        }).join('');
    }

    function deleteExpense(id) {
        if (!confirm('Are you sure you want to delete this expense record?')) return;
        
        const expenseIndex = allExpenses.findIndex(e => e.id === id);
        if (expenseIndex !== -1) {
            const expense = allExpenses[expenseIndex];
            const isDoctor = currentUser.role === 'Doctor';
            const canDelete = currentUser.role === 'Admin' || (isDoctor && currentUser.doctorName === expense.doctor);
            
            if (!canDelete) {
                 alert('You do not have permission to delete this expense.');
                 return;
            }

            allExpenses.splice(expenseIndex, 1);
            saveData();
            renderExpenseLog();
            updateDashboard();
        }
    }
    
    // --- LOCUM PAYMENTS ---
    function logLocumPayment() {
        const date = document.getElementById('locumPaymentDate').value;
        const doctor = document.getElementById('locumPaymentDoctor').value;
        const amount = parseFloat(document.getElementById('locumPaymentAmount').value) || 0;
        const notes = document.getElementById('locumPaymentNotes').value.trim();

        if (!date || !doctor || amount <= 0) {
            alert('Please fill in Date, Doctor, and a valid Amount > 0.');
            return;
        }
        
        // This is a crucial step: ensure only Admin can log payments
        if (currentUser.role !== 'Admin') {
            alert('Only an Admin can log locum payments.');
            return;
        }

        allLocumPayments.push({
            id: Date.now(),
            branch: currentBranch,
            date,
            doctor,
            amount,
            notes
        });
        saveData();
        alert(`Payment of ${formatCurrency(amount)} logged successfully for Dr. ${doctor}.`);

        // Reset form (keep date)
        document.getElementById('locumPaymentAmount').value = '0';
        document.getElementById('locumPaymentNotes').value = '';
        updateLocumSummary(); // Re-render summary and log, which recalculates the remaining balance
    }
    
    function renderLocumPaymentLog(doctorFilter = 'All') {
        const tableBody = document.getElementById('locumPaymentTableBody');
        let filteredPayments = allLocumPayments.filter(p => p.branch === currentBranch);
        
        if (doctorFilter !== 'All') {
            filteredPayments = filteredPayments.filter(p => p.doctor === doctorFilter);
        }
        
        filteredPayments.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (filteredPayments.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #94a3b8;">No locum payments logged.</td></tr>';
            return;
        }
        
        // Doctors can only see the log for their doctorName but not delete.
        const isDoctor = currentUser.role === 'Doctor';

        tableBody.innerHTML = filteredPayments.map(p => {
            // Can delete only if Admin
            const canDelete = currentUser.role === 'Admin';
            const actionHtml = canDelete ? `<button class="action-btn delete-btn" onclick="deleteLocumPayment(${p.id})">üóëÔ∏è Delete</button>` : 'üîí';

            return `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.date}</td>
                    <td>${p.doctor}</td>
                    <td style="color: #10b981;">${formatCurrency(p.amount)}</td>
                    <td>${p.notes || '-'}</td>
                    <td>${actionHtml}</td>
                </tr>
            `;
        }).join('');
    }

    function deleteLocumPayment(id) {
        if (!confirm('Are you sure you want to delete this locum payment record?')) return;
        
        if (currentUser.role !== 'Admin') {
            alert('Only an Admin can delete locum payments.');
            return;
        }

        allLocumPayments = allLocumPayments.filter(p => p.id !== id);
        saveData();
        updateLocumSummary();
    }
    
    
    // =========================================================================================
    // NEW: PATIENT AUTOFILL FUNCTIONS (Fulfills Request 1 & 2)
    // =========================================================================================

    /**
     * Gathers unique patient names and cell numbers from all transactions 
     * in the current branch and populates the hidden <datalist> for autofill.
     */
    function renderPatientDatalist() {
        // allTransactions must be a global variable holding all transaction data.
        if (typeof allTransactions === 'undefined' || !currentBranch) return;

        const branchTransactions = allTransactions.filter(t => t.branch === currentBranch);
        // Use a Map to ensure unique patient names and store the most recent cell number
        const uniquePatientsMap = new Map();
        branchTransactions.forEach(t => {
            const name = t.patientName.trim();
            const cell = t.cellNumber ? t.cellNumber.trim() : '';
            // Prioritize non-empty cell numbers and newer entries (later in the array loop)
            if (name) {
                // Store cell number for the name if it's new or the cell number is updated/newly present
                uniquePatientsMap.set(name, cell); 
            }
        });

        // Also include manually created patients from the New Patient form
        (allPatients || []).forEach(p => {
            const name = `${p.firstName} ${p.surname}`.trim();
            const cell = p.cellNumber ? p.cellNumber.trim() : '';
            if (name) uniquePatientsMap.set(name, cell);
        });

        const datalist = document.getElementById('patientDatalist');
        if (datalist) {
            datalist.innerHTML = ''; // Clear previous options
            
            uniquePatientsMap.forEach((cellNumber, name) => {
                const option = document.createElement('option');
                const normalized = normalizePhoneDigits(cellNumber) || '';
                const display = normalized ? formatPhoneDisplay(normalized) : (cellNumber || 'No cell #');
                option.value = name;
                // Store normalized cell number where available
                option.setAttribute('data-cell', normalized || cellNumber);
                // The content is shown to the user in the dropdown (pretty format if possible)
                option.textContent = `${name} (${display})`;
                datalist.appendChild(option);
            });
        }
    }

    /**
     * Checks if the input matches a name in the datalist and autofills the cell number.
     * @param {string} name - The current value of the patientName input.
     */
    function autofillPatientDetails(name) {
        const patientNameInput = document.getElementById('patientName');
        const cellNumberInput = document.getElementById('cellNumber');
        
        // Only check if the input has a value and is long enough
        if (!name || name.length < 2) {
            // Do not clear the cell number input immediately upon deleting the first character
            return;
        }
        
        const datalist = document.getElementById('patientDatalist');
        const options = datalist.querySelectorAll('option');
        let matchedCellNumber = '';

        // Loop through options to find a match and get the cell number
        for (let i = 0; i < options.length; i++) {
            // We check if the input value *exactly* matches an option value (which means the user selected it)
            if (options[i].value.toLowerCase() === name.toLowerCase()) {
                matchedCellNumber = options[i].getAttribute('data-cell');
                break;
            }
        }

        if (matchedCellNumber) {
            const normalized = normalizePhoneDigits(matchedCellNumber) || matchedCellNumber;
            cellNumberInput.value = normalizePhoneDigits(matchedCellNumber) ? formatPhoneDisplay(normalized) : matchedCellNumber;
        } else {
            // Optionally clear the cell number if no exact match is found
             cellNumberInput.value = '';
        }
    }

    // Save a new patient created from the New Patient form
    function saveNewPatient() {
        const id = (document.getElementById('newPatientId').value || '').trim();
        const first = (document.getElementById('newPatientFirstName').value || '').trim();
        const surname = (document.getElementById('newPatientSurname').value || '').trim();
        const cell = (document.getElementById('newPatientCell').value || '').trim();
        const address = (document.getElementById('newPatientAddress').value || '').trim();
        const dob = (document.getElementById('newPatientDOB')?.value || '').trim();

        if (!first || !surname || !cell) {
            showToast('First name, surname and cell number are required.', 'error');
            return;
        }

        const fullName = `${first} ${surname}`.trim();

        // Normalize phone
        let normalizedCell = normalizePhoneDigits(cell);
        if (!normalizedCell) {
            // Fallback: try to salvage digits if user entered a non-standard but numeric value
            const fallbackDigits = (cell || '').replace(/\D/g, '');
            if (fallbackDigits.length >= 7) {
                // If fallback digits look reasonable, accept them (store as-is)
                normalizedCell = fallbackDigits;
            } else {
                showToast('Invalid phone number. Please use a local mobile format (e.g., 071 234 5678 or +27 71 234 5678).', 'error');
                return;
            }
        }

        // If editing an existing patient
        if (id) {
            const idx = (allPatients || []).findIndex(p => String(p.id) === id);
            if (idx === -1) {
                showToast('Unable to find patient to update.', 'error');
                return;
            }

            const prev = { firstName: allPatients[idx].firstName, surname: allPatients[idx].surname, cellNumber: allPatients[idx].cellNumber, address: allPatients[idx].address, dob: allPatients[idx].dob };
            // Record edit history
            allPatients[idx].edits = allPatients[idx].edits || [];
            allPatients[idx].edits.push({ at: new Date().toISOString(), prev, changedBy: (currentUser && currentUser.doctorName) ? currentUser.doctorName : 'System' });

            const prevFullName = allPatients[idx].fullName;
            allPatients[idx].firstName = first;
            allPatients[idx].surname = surname;
            allPatients[idx].cellNumber = normalizedCell;
            allPatients[idx].address = address;
            allPatients[idx].dob = dob || allPatients[idx].dob || '';
            allPatients[idx].fullName = fullName;
            allPatients[idx].updatedAt = new Date().toISOString();

            // Update all transactions that reference the previous patient name
            allTransactions.forEach(t => {
                if (t.branch === currentBranch && t.patientName === prevFullName) {
                    t.patientName = fullName;
                }
            });

            saveData();
            renderPatientDatalist();
            clearNewPatientForm();
            showToast('Patient updated.');

            // Open patient card for the updated patient
            switchTab('patient-card', document.querySelector('#patientManagementGroup [data-tab="patient-card"]'), `üë• Patient Card`);
            document.getElementById('patientSearchInput').value = fullName;
            renderUniquePatientList();
            loadPatientCard(fullName);
            return;
        }

        // Check duplicate by exact name + normalized cell for new patients
        if ((allPatients || []).find(p => p.firstName.toLowerCase() === first.toLowerCase() && p.surname.toLowerCase() === surname.toLowerCase() && p.cellNumber === normalizedCell)) {
            showToast('Patient already exists.', 'error');
            return;
        }

        // Create patient record (store normalized cell)
        const patient = { id: Date.now(), firstName: first, surname: surname, cellNumber: normalizedCell, address: address, createdAt: new Date().toISOString(), fullName, edits: [] };

        allPatients.push(patient);
        
        // NEW: Create a waiting ticket for the new patient
        const ticketNum = nextTicketNumber++;
        const waitingTicket = {
            id: Date.now(),
            ticketNumber: ticketNum,
            patientId: patient.id,
            patientName: fullName,
            cellNumber: normalizedCell,
            proposedTreatment: '', // empty by default, to be filled by doctor/assistant
            createdAt: new Date().toISOString(),
            status: 'waiting', // statuses: 'waiting', 'in-treatment', 'completed', 'cancelled'
            treatments: [] // array of treatments added by assistant/doctor
        };
        allWaitingTickets.push(waitingTicket);
        
        saveData();
        renderPatientDatalist();
        clearNewPatientForm();
        showToast(`Patient saved. Ticket #${ticketNum} created and added to waiting list.`);
        
        // Open patient card and load the newly created patient
        switchTab('patient-card', document.querySelector('#patientManagementGroup [data-tab="patient-card"]'), `üë• Patient Card`);
        document.getElementById('patientSearchInput').value = fullName;
        renderUniquePatientList();
        loadPatientCard(fullName);
    }

    function clearNewPatientForm() {
        document.getElementById('newPatientId').value = '';
        document.getElementById('newPatientFirstName').value = '';
        document.getElementById('newPatientSurname').value = '';
        document.getElementById('newPatientCell').value = '';
        document.getElementById('newPatientDOB').value = '';
        document.getElementById('newPatientAddress').value = '';
    }

    // =========================================================================================
    // NEW: LOCUM PAYMENT AUTOFILL FUNCTION (Fulfills part of Request 3)
    // =========================================================================================

    /**
     * Calculates the current balance due for the selected doctor and populates the 
     * "Amount Paid" field in the log payment form for quick logging.
     */
    function populateLocumPaymentAmount() {
        const locumPaymentDoctor = document.getElementById('locumPaymentDoctor').value;
        const amountInput = document.getElementById('locumPaymentAmount');
        
        // If 'All' is selected in the payment form, we cannot auto-fill an amount
        if (locumPaymentDoctor === 'All') {
            amountInput.value = '0.00';
            return;
        }
        
        // Get the current Doctor selected in the SUMMARY tab (which controls the calculations)
        const summaryDoctorSelect = document.getElementById('locumDoctor');
        const originalSummaryDoctor = summaryDoctorSelect.value;
        
        // Temporarily set the summary's doctor to the payment doctor to calculate the single balance
        summaryDoctorSelect.value = locumPaymentDoctor; 
        
        // updateLocumSummary now returns the balance due
        const balanceDue = updateLocumSummary(); 
        
        // Restore the original summary doctor selection
        summaryDoctorSelect.value = originalSummaryDoctor;
        
        // Only pre-fill if the balance is positive (i.e., money is owed to the locum)
        if (balanceDue > 0) {
            amountInput.value = balanceDue.toFixed(2);
        } else {
            amountInput.value = '0.00';
        }

        // Re-render the summary if the tab is active and the doctor selection was changed
        // so the user sees the correct dashboard data for the original doctor selection.
        if (document.querySelector('.nav-item[data-tab="locum"]').classList.contains('active')) {
            updateLocumSummary(); 
        }
    }

    // =========================================================================================
    // MODIFIED: updateLocumSummary (Fulfills Request 3a & 3b Logic)
    // =========================================================================================

    /**
     * MODIFIED: Calculates total fee due, subtracts payments logged, renders the final balance, 
     * and returns the calculated Locum Balance Due.
     */
    function updateLocumSummary() {
        const doctorName = document.getElementById('locumDoctor').value;
        let filteredTransactions = allTransactions.filter(t => t.branch === currentBranch);
        const locumPayments = allLocumPayments.filter(p => p.branch === currentBranch);
        
        let currentLocumBalanceDue = 0;
        
        // If 'All' is selected, we calculate the SUM of each individual doctor's balance
        if (doctorName === 'All') {
            const allLocumDoctors = [...new Set(filteredTransactions.map(t => t.doctor))];
            
            currentLocumBalanceDue = allLocumDoctors.reduce((totalBalance, doc) => {
                const docTransactions = filteredTransactions.filter(t => t.doctor === doc);
                const docTotalCollected = docTransactions.reduce((sum, t) => sum + t.amountPaid, 0);
                const docTotalLabPaid = docTransactions.reduce((sum, t) => sum + t.labFeesPaid, 0);
                const docNetCollection = docTotalCollected - docTotalLabPaid;
                const docLocumFee = docNetCollection > 0 ? docNetCollection * locumFeePercentage : 0;
                
                const docPaymentsLogged = locumPayments
                    .filter(p => p.doctor === doc)
                    .reduce((sum, p) => sum + p.amount, 0);
                
                // Balance calculation (Fee Due - Payments Logged)
                return totalBalance + (docLocumFee - docPaymentsLogged);
            }, 0);
            
        } else {
            // Calculation for a single selected doctor
            filteredTransactions = filteredTransactions.filter(t => t.doctor === doctorName);

            const totalCollected = filteredTransactions.reduce((sum, t) => sum + t.amountPaid, 0);
            const totalLabPaid = filteredTransactions.reduce((sum, t) => sum + t.labFeesPaid, 0);

            const netCollection = totalCollected - totalLabPaid;
            // Locum Fee Due is 50% of the net collection from transactions
            const locumTotalFee = netCollection > 0 ? netCollection * locumFeePercentage : 0;
            
            // Locum Payments Logged (History) for this specific doctor
            const totalPaymentsLogged = locumPayments
                .filter(p => p.doctor === doctorName)
                .reduce((sum, p) => sum + p.amount, 0);

            // This is the core subtraction logic (Request 3b)
            currentLocumBalanceDue = locumTotalFee - totalPaymentsLogged;
        }

        
        // RENDER: Only the balance due stat is visible now (Request 3a)
        const balanceElement = document.getElementById('locum-balance-due');
        if (balanceElement) {
            balanceElement.textContent = formatCurrency(currentLocumBalanceDue);
            // Style based on balance: positive (green) if locum owes the clinic, negative (red) if clinic owes the locum
            // Assuming the common business view: a positive balance means the locum has been overpaid (clinic is owed).
            // A negative balance means the locum is owed money.
            
            // We display the *Amount Due TO LOCUM*. So if the number is positive (e.g. 5000), it's a debt to the locum.
            // We use the 'negative' style (red) to signify a debt/liability for the business.
            balanceElement.classList.toggle('negative', currentLocumBalanceDue > 0); 
            balanceElement.classList.toggle('positive', currentLocumBalanceDue < 0);
            balanceElement.classList.toggle('primary', currentLocumBalanceDue === 0);
            
            // If the balance is negative, we show the absolute value with a note.
            // Since this label is "AMOUNT DUE TO LOCUM", we flip the sign of a negative balance to show the amount *they* owe.
            // Example: Fee Due is 10000. Payments are 12000. Balance is -2000. This means locum owes the clinic 2000.
            // The logic above is based on the business's perspective (Locum Fee - Payments).
            if (currentLocumBalanceDue < 0) {
                 balanceElement.textContent = formatCurrency(Math.abs(currentLocumBalanceDue));
                 balanceElement.parentElement.querySelector('.stat-label').textContent = 'TOTAL BALANCE OWED BY LOCUM (Credit)';
            } else {
                 balanceElement.parentElement.querySelector('.stat-label').textContent = 'TOTAL AMOUNT DUE TO LOCUM (History Balance)';
            }
        }
        
        // Update period summary then render Payment Log
        updateLocumPeriodSummary();
        renderLocumPaymentLog(doctorName);
        
        // Return the balance due for use in populateLocumPaymentAmount
        return currentLocumBalanceDue;
    }

    // --- REPORT GENERATION ---
    function getFinancialsForPeriod(type, dateString) {
        let transactions = allTransactions.filter(t => t.branch === currentBranch);
        let startDate, endDate;
        const year = new Date(dateString).getFullYear();
        const month = new Date(dateString).getMonth();

        switch (type) {
            case 'daily':
                startDate = dateString;
                endDate = dateString;
                break;
            case 'weekly':
                startDate = startOfWeek(dateString);
                const start = new Date(startDate);
                endDate = new Date(start.setDate(start.getDate() + 6)).toISOString().split('T')[0];
                break;
            case 'monthly':
                startDate = new Date(year, month, 1).toISOString().split('T')[0];
                endDate = new Date(year, month + 1, 0).toISOString().split('T')[0];
                break;
            case 'quarterly':
                startDate = startOfQuarter(dateString);
                const quarterStart = new Date(startDate);
                endDate = new Date(quarterStart.setMonth(quarterStart.getMonth() + 3, 0)).toISOString().split('T')[0];
                break;
            case 'yearly':
                startDate = `${dateString}-01-01`;
                endDate = `${dateString}-12-31`;
                break;
        }

        transactions = transactions.filter(t => t.date >= startDate && t.date <= endDate).sort((a, b) => new Date(b.date) - new Date(a.date));

        // --- Core Calculations ---
        const totalCharged = transactions.reduce((sum, t) => sum + t.procedureFee, 0);
        const totalCollected = transactions.reduce((sum, t) => sum + t.amountPaid, 0);
        const totalLabFees = transactions.reduce((sum, t) => sum + t.labFees, 0);
        const totalLabPaid = transactions.reduce((sum, t) => sum + t.labFeesPaid, 0);
        const netCollection = totalCollected - totalLabPaid;
        const locumFee = netCollection * locumFeePercentage;
        
        const financials = { totalCharged, totalCollected, totalLabFees, totalLabPaid, netCollection, locumFee };
        
        // Procedure Summary
        const procedureSummary = transactions.reduce((acc, t) => {
            acc[t.procedure] = (acc[t.procedure] || 0) + 1;
            return acc;
        }, {});
        
        // Doctor Summary
        const doctorSummary = transactions.reduce((acc, t) => {
            const key = t.doctor;
            acc[key] = acc[key] || { charged: 0, collected: 0, netCollection: 0, locumFee: 0 };
            acc[key].charged += t.procedureFee;
            acc[key].collected += t.amountPaid;
            acc[key].netCollection += (t.amountPaid - t.labFeesPaid); // Net Collected
            acc[key].locumFee += (t.amountPaid - t.labFeesPaid) * locumFeePercentage; // Simple 50%
            return acc;
        }, {});
        
        // Get expenses for the period
        const periodExpenses = allExpenses.filter(e => e.branch === currentBranch && e.date >= startDate && e.date <= endDate );
        const totalExpenses = periodExpenses.reduce((sum, e) => sum + e.cost, 0);

        return { financials, procedureSummary, doctorSummary, periodExpenses, totalExpenses, transactions, startDate, endDate };
    }

    function createReportOutput(title, data, transactions) {
        let outputHtml = `<h3 class="card-title" style="margin-bottom: 10px; color: #60a5fa;">${title} Report for ${data.startDate} to ${data.endDate}</h3>`;
        outputHtml += `<p style="color: #94a3b8; margin-bottom: 30px;">Total Transactions: ${transactions.length}</p>`;

        // --- Financial Summary Table ---
        outputHtml += `<h4 class="card-title" style="font-size: 16px;">Financial Summary</h4>`;
        outputHtml += `<table class="report-table"><tbody>`;
        outputHtml += `<tr><td class="report-label">Total Procedures Charged</td><td class="report-value">${formatCurrency(data.financials.totalCharged)}</td></tr>`;
        outputHtml += `<tr><td class="report-label">Total Collected</td><td class="report-value">${formatCurrency(data.financials.totalCollected)}</td></tr>`;
        outputHtml += `<tr><td class="report-label">Total Lab Fees Incurred</td><td class="report-value">${formatCurrency(data.financials.totalLabFees)}</td></tr>`;
        outputHtml += `<tr><td class="report-label">Total Lab Fees Paid</td><td class="report-value">${formatCurrency(data.financials.totalLabPaid)}</td></tr>`;
        outputHtml += `<tr class="report-total"><td class="report-label">Net Collection (Collected - Lab Paid)</td><td class="report-value">${formatCurrency(data.financials.netCollection)}</td></tr>`;
        outputHtml += `<tr><td class="report-label">Calculated Locum Fee Due (${(locumFeePercentage * 100)}%)</td><td class="report-value">${formatCurrency(data.financials.locumFee)}</td></tr>`;
        outputHtml += `</tbody></table><br>`;

        // --- Doctor Summary ---
        outputHtml += `<h4 class="card-title" style="font-size: 16px; margin-top: 20px;">Doctor Performance Summary</h4>`;
        outputHtml += `<table class="report-table"><thead><tr><th>Doctor</th><th>Charged (R)</th><th>Collected (R)</th><th>Locum Fee (R)</th></tr></thead><tbody>`;
        for (const [doctor, summary] of Object.entries(data.doctorSummary)) {
             outputHtml += `<tr><td>${doctor}</td><td>${formatCurrency(summary.charged)}</td><td>${formatCurrency(summary.collected)}</td><td>${formatCurrency(summary.locumFee)}</td></tr>`;
        }
        outputHtml += `</tbody></table><br>`;

        // --- Procedure Summary ---
        outputHtml += `<h4 class="card-title" style="font-size: 16px; margin-top: 20px;">Procedure Count Summary</h4>`;
        outputHtml += `<table class="report-table"><thead><tr><th>Procedure</th><th>Count</th></tr></thead><tbody>`;
        for (const [procedure, count] of Object.entries(data.procedureSummary)) {
             outputHtml += `<tr><td class="report-label">${procedure}</td><td class="report-value">${count}</td></tr>`;
        }
        outputHtml += `</tbody></table><br>`;

        // --- Expense Summary ---
        outputHtml += `<h4 class="card-title" style="font-size: 16px; margin-top: 20px;">Period Expenses</h4>`;
        outputHtml += `<table class="report-table"><thead><tr><th>Item/Date</th><th>Cost (R)</th></tr></thead><tbody>`;
        data.periodExpenses.forEach(e => {
            outputHtml += `<tr><td class="report-label">${e.item} (${e.date})</td><td class="report-value" style="color:#ef4444;">${formatCurrency(e.cost)}</td></tr>`;
        });
        outputHtml += `<tr class="report-total"><td class="report-label">TOTAL EXPENSES</td><td class="report-value" style="color:#ef4444;">${formatCurrency(data.totalExpenses)}</td></tr>`;
        outputHtml += `</tbody></table><br>`;

        return outputHtml;
    }

    // Minimal locum period summary (for selected period + doctor)
    function updateLocumPeriodSummary() {
        const periodTypeEl = document.getElementById('locumPeriod');
        const periodDateEl = document.getElementById('locumPeriodDate');
        const doctorEl = document.getElementById('locumDoctor');
        const periodType = periodTypeEl ? periodTypeEl.value : 'daily';
        const periodDate = periodDateEl ? (periodDateEl.value || todayDateString()) : todayDateString();
        const doctor = doctorEl ? doctorEl.value : 'All';

        let reportData;
        let transactions;
        if (periodType === 'all') {
            transactions = allTransactions.filter(t => t.branch === currentBranch);
            reportData = { startDate: '0000-01-01', endDate: '9999-12-31', transactions };
        } else {
            // Reuse existing report generator logic to obtain transactions and date range
            reportData = getFinancialsForPeriod(periodType, periodDate);
            transactions = reportData.transactions;
        }

        if (doctor !== 'All') transactions = transactions.filter(t => t.doctor === doctor);

        const totalCollected = transactions.reduce((s, t) => s + t.amountPaid, 0);
        const totalLabPaid = transactions.reduce((s, t) => s + t.labFeesPaid, 0);
        const netCollection = totalCollected - totalLabPaid;
        const locumFee = netCollection > 0 ? netCollection * locumFeePercentage : 0;

        const paymentsInRange = allLocumPayments.filter(p => p.branch === currentBranch && p.date >= reportData.startDate && p.date <= reportData.endDate && (doctor === 'All' || p.doctor === doctor));
        const totalPaidPeriod = paymentsInRange.reduce((s, p) => s + p.amount, 0);

        // Render into UI
        const elTotalCollected = document.getElementById('locum-total-collected');
        const elNet = document.getElementById('locum-net-collection');
        const elFee = document.getElementById('locum-fee-period');
        const elPaid = document.getElementById('locum-paid-period');
        const elBalance = document.getElementById('locum-balance-period');

        if (elTotalCollected) elTotalCollected.textContent = formatCurrency(totalCollected);
        if (elNet) elNet.textContent = formatCurrency(netCollection);
        if (elFee) elFee.textContent = formatCurrency(locumFee);
        if (elPaid) elPaid.textContent = formatCurrency(totalPaidPeriod);
        if (elBalance) elBalance.textContent = formatCurrency(locumFee - totalPaidPeriod);
    }

    // Run a quick consistency check and show a small alert with any mismatches
    function parseCurrencyNumber(text) {
        if (!text) return 0;
        const num = text.replace(/[R\s,]/g, '').replace(/[^0-9.\-]/g, '');
        return parseFloat(num) || 0;
    }

    function runLocumSmokeTest() {
        // Ensure UI is up to date
        updateLocumPeriodSummary();
        const periodBalanceEl = document.getElementById('locum-balance-period');
        const historyBalanceEl = document.getElementById('locum-balance-due');

        const periodBalanceUI = parseCurrencyNumber(periodBalanceEl ? periodBalanceEl.textContent : 'R 0');
        const historyBalanceUI = parseCurrencyNumber(historyBalanceEl ? historyBalanceEl.textContent : 'R 0');

        // Recompute expected values
        const periodTypeEl = document.getElementById('locumPeriod');
        const periodDateEl = document.getElementById('locumPeriodDate');
        const doctorEl = document.getElementById('locumDoctor');
        const periodType = periodTypeEl ? periodTypeEl.value : 'daily';
        const periodDate = periodDateEl ? (periodDateEl.value || todayDateString()) : todayDateString();
        const doctor = doctorEl ? doctorEl.value : 'All';

        let reportData;
        let tx;
        if (periodType === 'all') {
            tx = allTransactions.filter(t => t.branch === currentBranch && (doctor === 'All' || t.doctor === doctor));
            reportData = { startDate: '0000-01-01', endDate: '9999-12-31', transactions: tx };
        } else {
            reportData = getFinancialsForPeriod(periodType, periodDate);
            tx = reportData.transactions.filter(t => (doctor === 'All' || t.doctor === doctor));
        }

        const totalCollected = tx.reduce((s, t) => s + t.amountPaid, 0);
        const totalLabPaid = tx.reduce((s, t) => s + t.labFeesPaid, 0);
        const netCollection = totalCollected - totalLabPaid;
        const locumFee = netCollection > 0 ? netCollection * locumFeePercentage : 0;
        const paymentsInRange = allLocumPayments.filter(p => p.branch === currentBranch && p.date >= reportData.startDate && p.date <= reportData.endDate && (doctor === 'All' || p.doctor === doctor));
        const totalPaidPeriod = paymentsInRange.reduce((s, p) => s + p.amount, 0);
        const expectedPeriodBalance = parseFloat((locumFee - totalPaidPeriod).toFixed(2));

        // Recompute history balance using same logic as updateLocumSummary
        const historyBalance = (function() {
            if (doctor === 'All') {
                const allLocumDoctors = [...new Set(allTransactions.filter(t => t.branch === currentBranch).map(t => t.doctor))];
                const balance = allLocumDoctors.reduce((total, doc) => {
                    const docTx = allTransactions.filter(t => t.branch === currentBranch && t.doctor === doc);
                    const docCollected = docTx.reduce((s, t) => s + t.amountPaid, 0);
                    const docLabPaid = docTx.reduce((s, t) => s + t.labFeesPaid, 0);
                    const docNet = docCollected - docLabPaid;
                    const docFee = docNet > 0 ? docNet * locumFeePercentage : 0;
                    const docPayments = allLocumPayments.filter(p => p.branch === currentBranch && p.doctor === doc).reduce((s, p) => s + p.amount, 0);
                    return total + (docFee - docPayments);
                }, 0);
                return parseFloat(balance.toFixed(2));
            } else {
                const docTx = allTransactions.filter(t => t.branch === currentBranch && t.doctor === doctor);
                const collected = docTx.reduce((s, t) => s + t.amountPaid, 0);
                const labPaid = docTx.reduce((s, t) => s + t.labFeesPaid, 0);
                const net = collected - labPaid;
                const fee = net > 0 ? net * locumFeePercentage : 0;
                const payments = allLocumPayments.filter(p => p.branch === currentBranch && p.doctor === doctor).reduce((s, p) => s + p.amount, 0);
                return parseFloat((fee - payments).toFixed(2));
            }
        })();

        const mismatches = [];
        if (Math.abs(expectedPeriodBalance - periodBalanceUI) > 0.01) mismatches.push(`Period balance mismatch: UI=${periodBalanceUI} expected=${expectedPeriodBalance}`);
        if (Math.abs(historyBalance - historyBalanceUI) > 0.01) mismatches.push(`History balance mismatch: UI=${historyBalanceUI} expected=${historyBalance}`);

        if (mismatches.length === 0) {
            alert('Smoke test passed: locum period & history balances are consistent.');
        } else {
            alert('Smoke test found inconsistencies:\n' + mismatches.join('\n'));
        }
    }

    function generateReport(type) {
        const inputId = `${type}ReportDate`;
        const outputId = `${type}ReportOutput`;
        const dateInput = document.getElementById(inputId);
        const outputElement = document.getElementById(outputId);
        const dateString = dateInput.value;

        if (!dateString) {
            outputElement.innerHTML = `<p style="color: #94a3b8; text-align: center;">Please select a date.</p>`;
            return;
        }
        
        // Handle yearly report input format
        let effectiveDateString = dateString;
        if (type === 'yearly') {
            effectiveDateString = `${dateString}-01-01`; // Use Jan 1st of that year
        }

        const reportData = getFinancialsForPeriod(type, effectiveDateString);
        
        let title;
        if (type === 'weekly') {
            title = `Weekly (${reportData.startDate} - ${reportData.endDate})`;
        } else if (type === 'monthly') {
            title = `Monthly (${new Date(effectiveDateString).toLocaleString('default', { month: 'long', year: 'numeric' })})`;
        } else if (type === 'quarterly') {
             title = `Quarterly (${reportData.startDate} - ${reportData.endDate})`;
        } else if (type === 'yearly') {
             title = `Yearly (${dateString})`;
        } else {
            title = `Daily (${dateString})`;
        }

        outputElement.innerHTML = createReportOutput(title, reportData, reportData.transactions);
    }
    
    // --- USER/LOGIN MANAGEMENT ---
    function selectBranch(branchName, element) {
        currentBranch = branchName;
        document.querySelectorAll('.branch-btn').forEach(btn => btn.classList.remove('active'));
        element.classList.add('active');
        
        document.getElementById('welcomeScreen').classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('loginBranchName').textContent = branchName;
        
        // Clear login inputs (do not prefill credentials)
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
    }

    function applyRoleRestrictions(role, doctorName) {
        const doctorSelects = ['doctor', 'apptDoctor', 'locumDoctor', 'locumPaymentDoctor'];
        const locumSelect = document.getElementById('locumDoctor');
        
        // === 1. Doctor/Staff Input Restrictions ===
        if (role === 'Doctor') {
            // Restrict doctor inputs to their own name
            doctorSelects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = `<option>${doctorName}</option>`;
                    select.value = doctorName;
                    select.disabled = true; // Prevent changing
                }
            });
            
            // Restrict Locum Summary to themselves
            if (locumSelect) {
                locumSelect.innerHTML = `<option>${doctorName}</option>`;
                locumSelect.disabled = true; 
                locumSelect.value = doctorName; // Ensure value is set
            }
            
        } else {
            // Admin/Assistant: Restore full functionality
            doctorSelects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    if (id === 'expenseDoctor') {
                        select.innerHTML = defaultExpenseOptions;
                    } else {
                        select.innerHTML = defaultDoctorOptions;
                    }
                    select.disabled = false;
                }
            });
            
            // Restore functionality for Locum Summary
            if (locumSelect) {
                // Restore "All" option for Admin/Assistance
                locumSelect.innerHTML = '<option value="All">All Doctors</option>' + defaultDoctorOptions;
                locumSelect.disabled = false;
                locumSelect.value = 'All'; // Default back to 'All'
            }
        }
        
        // === 2. Financial Reports Restriction (Hide all but Daily Report for Doctor & Assistant) ===
        const financialReports = ['nav-weekly-report', 'nav-monthly-report', 'nav-quarterly-report', 'nav-yearly-report'];
        // Hide reports if the role is Doctor or Assistance
        const hideReports = (role === 'Doctor' || role === 'Assistance');
        financialReports.forEach(id => {
            const navItem = document.getElementById(id);
            if (navItem) {
                navItem.classList.toggle('hidden', hideReports);
            }
        });

        // === 3. Locum Summary Restriction (Doctor can view, Admin can view/log, Assistant cannot view) ===
        const locumNav = document.querySelector('[data-tab="locum"]');
        const locumPaymentLogSection = document.getElementById('locumPaymentLogSection');
        if (locumNav) {
            // 1. New: Hide Locum Summary nav item for Assistance role
            locumNav.classList.toggle('hidden', role === 'Assistance');
            
            // Hide Locum Payment logging for everyone but Admin
            const hideLogPayment = (role !== 'Admin');
            if (locumPaymentLogSection) {
                locumPaymentLogSection.classList.toggle('hidden', hideLogPayment);
            }
        }
    }

    function login() {
        const usernameInput = document.getElementById('username').value;
        const passwordInput = document.getElementById('password').value;
        
        // For demo mode: if a user's password is empty in the users array, allow login by username only.
        const user = users.find(u => u.username === usernameInput && (u.password === '' || u.password === passwordInput));

        if (user) {
            // Set current user object without storing password
            currentUser = { ...user };
            delete currentUser.password;
            saveData(); // persist currentBranch/currentUser in sessionStorage

            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('branchContainer').classList.remove('hidden');
            document.getElementById('quickMenu').classList.remove('hidden');
            document.getElementById('loggedInUserDisplay').classList.remove('hidden');
            
            document.getElementById('loggedInUserName').textContent = `${user.doctorName} (${user.role})`;
            
            // Display current branch and date
            document.getElementById('currentBranchDisplay').classList.remove('hidden');
            document.getElementById('currentBranchDisplay').textContent = `Branch: ${currentBranch}`;
            document.getElementById('currentBranchDate').textContent = `Today: ${todayDateString()}`;

            // Apply all role restrictions here
            applyRoleRestrictions(currentUser.role, currentUser.doctorName);
            updateDashboard();
            renderPatientDatalist(); // ADDED: Render the patient datalist after data is loaded
            switchTab('dashboard', document.querySelector('.nav-item[data-tab="dashboard"]'));
            
        } else {
            alert('Invalid username or password.');
            document.getElementById('password').value = '';
        }
    }

    function logout() {
        currentUser = null;
        currentBranch = null;
        sessionStorage.removeItem('currentBranch');
        sessionStorage.removeItem('currentUser');
        
        document.getElementById('branchContainer').classList.add('hidden');
        document.getElementById('quickMenu').classList.add('hidden');
        document.getElementById('loggedInUserDisplay').classList.add('hidden');
        document.getElementById('welcomeScreen').classList.remove('hidden');
        document.getElementById('currentBranchDisplay').classList.add('hidden');
        
        document.querySelectorAll('.branch-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('loginBranchName').textContent = '';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        switchTab('welcomeScreen', null);
    }
    
    function switchTab(tabId, element, title = '') {
        // Hide all tab content
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        // Remove active class from all nav items
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

        // Show the selected tab content
        const selectedTab = document.getElementById(`tab-${tabId}`);
        if (selectedTab) {
            selectedTab.classList.remove('hidden');
        }

        // Set active class on the nav item
        if (element) {
            element.classList.add('active');
        }
        
        // Update the main title
        if (title) {
            document.getElementById('viewTitle').textContent = title;
        }

        // Auto-open relevant nav-group when a submenu/tab is activated
        // Close other open groups first
        document.querySelectorAll('.nav-group.open').forEach(g => {
            if (!element || !g.contains(element)) {
                g.classList.remove('open');
                const caret = g.querySelector('.group-caret');
                if (caret) caret.textContent = '‚ñ∏';
            }
        });

        // If we activated a submenu element, open its parent group
        if (element) {
            const submenu = element.closest('.nav-submenu');
            if (submenu) {
                const group = submenu.closest('.nav-group');
                if (group && !group.classList.contains('open')) {
                    group.classList.add('open');
                    const caret = group.querySelector('.group-caret');
                    if (caret) caret.textContent = '‚ñæ';
                }
            }
        }

        // Also handle cases where tabId references a submenu directly (no element provided)
        if (!element) {
            // Generalize: auto-open the nav-group which *contains* the submenu with this tabId
            const groups = document.querySelectorAll('.nav-group');
            groups.forEach(group => {
                const caret = group.querySelector('.group-caret');
                const match = group.querySelector(`.nav-submenu [data-tab="${tabId}"]`);
                if (match) {
                    if (!group.classList.contains('open')) {
                        group.classList.add('open');
                        if (caret) caret.textContent = '‚ñæ';
                    }
                } else {
                    if (group.classList.contains('open')) {
                        group.classList.remove('open');
                        if (caret) caret.textContent = '‚ñ∏';
                    }
                }
            });
        }


        // Run specific update functions for certain tabs
        if (tabId === 'dashboard') {
          updateDashboard();
        } else if (tabId === 'add-transaction') { // ADDED: Ensure datalist is current when opening form
          renderPatientDatalist(); 
        } else if (tabId === 'accounts') {
          // Populate doctor dropdown and render transactions
          populateAccountsDoctorFilter();
          renderAccountsTransactions();
        } else if (tabId === 'new-patient') {
          clearNewPatientForm();
          document.getElementById('newPatientFirstName').focus();
          renderPatientDatalist();
        } else if (tabId === 'patient-card') {
          renderUniquePatientList(); // Initial render for the search list
          if (selectedPatientName) {
              loadPatientCard(selectedPatientName); // Reload details if patient is already selected
          }
        } else if (tabId === 'daily-expense') {
          document.getElementById('expenseDate').value = todayDateString();
          renderExpenseLog();
        } else if (tabId === 'locum') {
          // Select default doctor/all based on role and trigger summary update
          const locumDoctorSelect = document.getElementById('locumDoctor');
          if (currentUser.role === 'Admin' || currentUser.role === 'Assistance') {
             locumDoctorSelect.value = 'All';
          }
          document.getElementById('locumPaymentDate').value = todayDateString();
          updateLocumSummary();
          populateLocumPaymentAmount(); // Also run initial autofill for the payment form
        } else if (tabId === 'appointments') {
            document.getElementById('apptDate').value = todayDateString();
            renderAppointments();
        } else if (tabId === 'stock') {
            switchStockTab('items', document.querySelector('.stock-tab-btn[onclick*="items"]'));
        }
    }

    // Billing helpers
    function renderBillingSummary(period = 'daily') {
        if (!document.getElementById('billingSummaryTotals')) return;
        // Compute start/end dates
        const today = new Date();
        let startDate, endDate;
        const dateStr = todayDateString();
        if (period === 'daily') {
            startDate = dateStr; endDate = dateStr;
        } else if (period === 'weekly') {
            startDate = startOfWeek(dateStr);
            endDate = new Date(new Date(startDate).setDate(new Date(startDate).getDate() + 6)).toISOString().split('T')[0];
        } else {
            startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
        }

        const tx = (allTransactions || []).filter(t => t.branch === currentBranch && t.date >= startDate && t.date <= endDate);
        const totalCollected = tx.reduce((s, t) => s + (t.amountPaid || 0), 0);
        const totalCount = tx.length;
        document.getElementById('billingSummaryTotals').innerHTML = `<strong>${totalCount}</strong> transaction(s), <strong>${formatCurrency(totalCollected)}</strong> collected (${period}).`;
        renderTransactionsLog(tx);
    }

    function renderTransactionsLog(transactions) {
        const container = document.getElementById('transactionsLogTable');
        if (!container) return;
        const rows = (transactions || (allTransactions || [])).slice().sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 100);
        if (rows.length === 0) {
            container.innerHTML = '<p style="color:#94a3b8;">No transactions for this period.</p>';
            return;
        }

        container.innerHTML = `<table style="width:100%; border-collapse:collapse;"><thead><tr style="text-align:left;"><th>Date</th><th>Patient</th><th>Amount</th></tr></thead><tbody>${rows.map(r => `<tr><td>${r.date}</td><td>${r.patientName || '-'}</td><td>${formatCurrency(r.amountPaid || 0)}</td></tr>`).join('')}</tbody></table>`;
    }

    // Invoices and Transactions History features removed per UX decision. Functions and UI for those menus were removed to simplify the Billing section.

    function escapeHtml(s) { return (s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    function populateAccountsDoctorFilter() {
        // Get unique doctors from transactions in current branch
        const doctors = new Set();
        (allTransactions || []).forEach(t => {
            if (t.branch === currentBranch && t.doctor) doctors.add(t.doctor);
        });

        // Populate dropdown (keep "All Doctors" option)
        const select = document.getElementById('accountsDoctorFilter');
        if (select) {
            const currentVal = select.value;
            const options = ['<option value="">All Doctors</option>'];
            Array.from(doctors).sort().forEach(doctor => {
                options.push(`<option>${escapeHtml(doctor)}</option>`);
            });
            select.innerHTML = options.join('');
            select.value = currentVal;
        }
    }

    function populateAccountsDoctorFilter() {
        const select = document.getElementById('accountsDoctorFilter');
        if (!select) return;
        // Collect unique doctors for current branch
        const doctors = Array.from(new Set((allTransactions || [])
            .filter(t => t.branch === currentBranch)
            .map(t => t.doctor)
            .filter(Boolean)));
        const cur = select.value || '';
        // Rebuild options
        let opts = '<option value="">All Doctors</option>' + doctors.map(d => `
            <option value="${escapeHtml(d)}" ${escapeHtml(d) === escapeHtml(cur) ? 'selected' : ''}>${escapeHtml(d)}</option>
        `).join('');
        select.innerHTML = opts;
    }

    function renderAccountsTransactions() {
        // Read filter inputs
        const patientFilterVal = (document.getElementById('accountsPatientFilter')?.value || '').toLowerCase();
        const doctorFilterVal = document.getElementById('accountsDoctorFilter')?.value || '';
        const fromDateVal = document.getElementById('accountsFromDate')?.value || '';
        const toDateVal = document.getElementById('accountsToDate')?.value || '';

        // Parse dates for comparison
        const fromDate = fromDateVal ? new Date(fromDateVal) : new Date('1900-01-01');
        const toDate = toDateVal ? new Date(toDateVal) : new Date('2099-12-31');

        // Filter transactions
        let filtered = (allTransactions || []).filter(t => {
            // Branch filter
            if (t.branch !== currentBranch) return false;
            // Patient name filter (contains, case-insensitive)
            if (patientFilterVal && !(t.patientName || '').toLowerCase().includes(patientFilterVal)) return false;
            // Doctor filter (exact match)
            if (doctorFilterVal && t.doctor !== doctorFilterVal) return false;
            // Date range filter
            const tDate = new Date(t.date);
            if (tDate < fromDate || tDate > toDate) return false;
            return true;
        });

        // Calculate summary totals
        let totalCharged = 0, totalCollected = 0, totalLabFees = 0;
        filtered.forEach(t => {
            totalCharged += (t.procedureFee || 0);
            totalCollected += (t.amountPaid || 0);
            totalLabFees += (t.labFees || 0);
        });
        const outstandingBalance = totalCharged - totalCollected;

        // Build transaction table HTML
        let tableHtml = filtered.map(t => `
            <tr>
                <td>${t.date}</td>
                <td>${escapeHtml(t.doctor || '')}</td>
                <td>${escapeHtml(t.patientName || '')}</td>
                <td>${escapeHtml(t.procedureName || '')}</td>
                <td style="text-align:right">${formatCurrency(t.procedureFee || 0)}</td>
                <td style="text-align:right">${formatCurrency(t.amountPaid || 0)}</td>
                <td style="text-align:right">${formatCurrency((t.procedureFee || 0) - (t.amountPaid || 0))}</td>
                <td style="text-align:right">${formatCurrency(t.labFees || 0)}</td>
                <td style="text-align:right">${formatCurrency(t.labFeesPaid || 0)}</td>
            </tr>
        `).join('');

        // Update table
        const tableBody = document.getElementById('accountsTransactionsTable');
        if (tableBody) tableBody.innerHTML = tableHtml || '<tr><td colspan="9" style="text-align:center;color:#94a3b8;">No transactions for selected filters.</td></tr>';

        // Update summary stat cards
        document.getElementById('accounts-stat-charged')
            && (document.getElementById('accounts-stat-charged').textContent = formatCurrency(totalCharged));
        document.getElementById('accounts-stat-collected')
            && (document.getElementById('accounts-stat-collected').textContent = formatCurrency(totalCollected));
        document.getElementById('accounts-stat-balance')
            && (document.getElementById('accounts-stat-balance').textContent = formatCurrency(outstandingBalance));
        document.getElementById('accounts-stat-lab')
            && (document.getElementById('accounts-stat-lab').textContent = formatCurrency(totalLabFees));

        // Show a matched hint if the patient filter uniquely identifies a single patient name
        const matchedHintEl = document.getElementById('accountsMatchedHint');
        if (patientFilterVal && matchedHintEl) {
            const candidates = Array.from(new Set((allTransactions || [])
                .filter(t => t.branch === currentBranch && (t.patientName || '').toLowerCase().includes(patientFilterVal))
                .map(t => t.patientName)));
            if (candidates.length === 1) {
                matchedHintEl.textContent = `Matched: ${candidates[0]}`;
            } else {
                matchedHintEl.textContent = '';
            }
        } else if (matchedHintEl) {
            matchedHintEl.textContent = '';
        }
    }

    // Clinic info & doctor registry helper
    const CLINIC_STATION_MEDICAL_ADDRESS = '06 Cnr Harvey Rd & Charles Street, Bfn Station Medical Centre, Bloemfontein';
    const DOCTOR_REGISTRY = {
        'M. Mokoma': 'Pr No: 0667439 BDTH-Ukzn',
        'M. Lepele': 'Pr No.: 1078178 OH UWC'
    };

    function getDoctorDisplay(name) {
        if (!name) name = 'M. Mokoma'; // default
        const clean = name.replace(/\s+/g, ' ').trim();
        const reg = DOCTOR_REGISTRY[clean];
        return reg ? `${clean} (${reg})` : clean;
    }

    // Preview an account statement for the patient named in the Accounts patient filter
    function previewAccountsStatement() {
        const rawInput = (document.getElementById('accountsPatientFilter')?.value || '').trim();
        if (!rawInput) {
            showToast('Please enter/select a patient name to view statement.', 'error');
            return;
        }

        // Match transactions using case-insensitive substring to be more forgiving
        const matches = (allTransactions || []).filter(t => t.branch === currentBranch && (t.patientName || '').toLowerCase().includes(rawInput.toLowerCase()));
        if (matches.length === 0) {
            showToast('No transactions found for that patient in this branch.', 'error');
            console.debug('previewAccountsStatement: no matches for', rawInput);
            return;
        }

        // If multiple distinct patient names matched and user did not type a full name, ask for disambiguation
        const distinctPatients = Array.from(new Set(matches.map(m => m.patientName)));
        let patientName = rawInput;
        if (distinctPatients.length > 1) {
            // If rawInput exactly matches one of the distinct patient names (case-insensitive), prefer it
            const exactMatch = distinctPatients.find(p => p.toLowerCase() === rawInput.toLowerCase());
            if (exactMatch) {
                patientName = exactMatch;
            } else {
                showToast('Multiple patients matched. Please enter the full patient name to view a specific statement.', 'error');
                console.debug('previewAccountsStatement: ambiguous matches', distinctPatients);
                return;
            }
        } else {
            patientName = distinctPatients[0];
        }

        // Build the statement header (details and totals will be computed from patient transactions below)
        let statement = `MAISHA DENTAL CLINICS - ACCOUNT STATEMENT\n\n`;
        statement += `${CLINIC_STATION_MEDICAL_ADDRESS}\n\n`;
        statement += `Patient: ${patientName}\n`;
        statement += `Date: ${todayDateString()}\n\n`;
        statement += `Summary of Charges and Payments:\n`;
        matches.forEach(t => {
            statement += `- ${t.date}: ${t.procedure} (${t.toothNumbers || 'N/A'}) - Charge: ${formatCurrency(t.procedureFee)}, Paid: ${formatCurrency(t.amountPaid)}\n`;
        });
        statement += `\n========================================\n`;
        // Note: totals will be attached once the patient-specific transaction list is computed below (to keep calculations consistent)


        // Helper function for download (sets a headless-friendly flag)
        window.downloadStatement = function () {
            // Record an attempt so headless tests can detect a download
            try {
                window._lastStatementDownload = { patientName: patientName, filename: `Statement_${patientName.replace(/\s+/g,'_')}_${Date.now()}.txt` };
            } catch (e) { window._lastStatementDownload = { patientName: patientName, filename: null }; }

            const blob = new Blob([statement], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Statement_${patientName.replace(/\s+/g,'_')}_${Date.now()}.txt`;
            document.body.appendChild(link);
            try { link.click(); } catch (e) { console.debug('downloadStatement: not supported in headless'); }
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Statement downloaded');
        };

        const patientData = matches.filter(t => t.patientName === patientName).slice().sort((a,b)=>new Date(b.date)-new Date(a.date));

        // Use the most recent transaction date as the statement date
        const statementDate = patientData[0]?.date || todayDateString();

        let docContent = `MAISHA DENTAL CLINICS - ACCOUNT STATEMENT\n`;
        docContent += `${CLINIC_STATION_MEDICAL_ADDRESS}\n\n`;
        docContent += `Patient: ${patientName}\n`;
        docContent += `Date: ${statementDate}\n\n`;

        patientData.forEach(t => {
            const procName = t.procedure || t.procedureName || '-';
            const toothInfo = t.toothNumbers || 'N/A';
            const qty = (t.quantity !== undefined && t.quantity !== null) ? t.quantity : 1;
            const fee = t.procedureFee || 0;
            const paid = t.amountPaid || 0;
            const balance = (t.balance !== undefined && t.balance !== null) ? t.balance : (fee - paid);
            const notes = t.treatmentNotes || t.notes || 'N/A';
            const doctorDisplay = getDoctorDisplay(t.doctor);

            docContent += `Date: ${t.date}\n`;
            docContent += `Doctor: ${doctorDisplay}\n`;
            docContent += `Procedure: ${procName} (Tooth: ${toothInfo} / Qty: ${qty})\n`;
            docContent += `Fee: ${formatCurrency(fee)} | Paid: ${formatCurrency(paid)} | Balance: ${formatCurrency(balance)}\n`;
            docContent += `Notes: ${notes}\n`;
            docContent += `----------------------------------------\n\n`;
        });

        docContent += `${'='.repeat(40)}\n`;
        const totalFee = patientData.reduce((s, t) => s + (t.procedureFee || 0), 0);
        const totalPaid = patientData.reduce((s, t) => s + (t.amountPaid || 0), 0);
        const outstanding = totalFee - totalPaid;
        docContent += `TOTAL CHARGED: ${formatCurrency(totalFee)}\n`;
        docContent += `TOTAL PAID: ${formatCurrency(totalPaid)}\n`;
        docContent += `OUTSTANDING BALANCE: ${formatCurrency(outstanding)}\n`;
        docContent += `${'='.repeat(40)}\n`;

        const previewArea = document.getElementById('documentPreviewArea');
        if (previewArea) {
            // Keep a copy for download helper
            statement = docContent;
            previewArea.textContent = docContent;
            previewArea.classList.remove('hidden');
            // Scroll the preview into view for better UX (guarded for headless environments)
            if (typeof previewArea.scrollIntoView === 'function') {
                try { previewArea.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (e) { /* ignore in unsupported env */ }
            }
            // Auto-trigger a download so 'View Statement' alone handles the download action
            try { window.downloadStatement(); } catch (e) { /* ignore in unsupported env */ }
        }
    }

    // Expose helpers to window for testability and external invocation
    try {
        window.escapeHtml = escapeHtml; // NEW: Expose escapeHtml
        window.populateAccountsDoctorFilter = populateAccountsDoctorFilter;
        window.renderAccountsTransactions = renderAccountsTransactions;
        window.previewAccountsStatement = previewAccountsStatement;
        // Test helper: programmatically update a transaction without relying on UI
        window.testHelpers = window.testHelpers || {};
        window.testHelpers.updateTransaction = function (id, partial) {
            const idx = allTransactions.findIndex(t => t.id === id);
            if (idx === -1) return false;
            allTransactions[idx] = Object.assign({}, allTransactions[idx], partial);
            // Recompute balance for that transaction
            allTransactions[idx].balance = (allTransactions[idx].procedureFee || 0) - (allTransactions[idx].amountPaid || 0);
            saveData();
            return true;
        };
    } catch (e) {}

    // Toggle a nav-group open/closed (used for side-menu submenus)
    function toggleNavGroup(groupId) {
        const group = document.getElementById(groupId);
        if (!group) return;
        group.classList.toggle('open');
        const caret = group.querySelector('.group-caret');
        if (caret) caret.textContent = group.classList.contains('open') ? '‚ñæ' : '‚ñ∏';
    }

    // --- PATIENT CARD & CHART ---
    function renderUniquePatientList() {
        const searchInput = document.getElementById('patientSearchInput').value.toLowerCase().trim();
        const branchTransactions = allTransactions.filter(t => t.branch === currentBranch);
        
        // Get unique patient names and cell numbers
        let uniqueNamesMap = new Map();
        branchTransactions.forEach(t => {
            const name = t.patientName.trim();
            const cell = t.cellNumber ? t.cellNumber.trim() : '';
            if (name.toLowerCase().includes(searchInput)) {
                // Keep the last/most recent cell number
                uniqueNamesMap.set(name, cell);
            }
        });

        const listContainer = document.getElementById('uniquePatientList');
        if (uniqueNamesMap.size === 0) {
            listContainer.innerHTML = `<p style="text-align: center; color: #94a3b8; padding-top: 15px;">No patients found matching "${searchInput}".</p>`;
            return;
        }

        let listHtml = '';
        uniqueNamesMap.forEach((cellNumber, name) => {
             listHtml += `<div class="nav-item" onclick="loadPatientCard('${name}')">
                <span>üë§</span> 
                <div style="flex-grow: 1;">
                    <span style="font-weight: 600;">${name}</span>
                    <p style="font-size: 11px; color: #94a3b8; margin-top: 2px;">${cellNumber || 'No Cell #'}</p>
                </div>
             </div>`;
        });
        
        listContainer.innerHTML = listHtml;
    }

    function loadPatientCard(patientName) {
        selectedPatientName = patientName;
        document.getElementById('patientCardHeader').textContent = `üë§ Patient Card: ${patientName}`;
        // Update pediatric guidance (if a patient has DOB stored)
        computePediatricDose();
        
        // Find saved patient record (if any)
        const savedPatient = (allPatients || []).find(p => `${p.firstName} ${p.surname}`.trim() === patientName);

        // Show edit/delete/history buttons when a patient is selected
        const editBtn = document.getElementById('editPatientBtn');
        if (editBtn) { editBtn.style.display = 'inline-block'; editBtn.dataset.patientName = patientName; }
        const delBtn = document.getElementById('deletePatientBtn');
        if (delBtn) { delBtn.style.display = 'inline-block'; delBtn.dataset.patientName = patientName; delBtn.dataset.patientId = savedPatient ? savedPatient.id : ''; }
        const histBtn = document.getElementById('toggleHistoryBtn');
        if (histBtn) { histBtn.style.display = savedPatient ? 'inline-block' : 'none'; histBtn.dataset.patientName = patientName; }

        // Render patient edit history if available
        if (savedPatient) {
            renderPatientEditHistory(savedPatient);
        } else {
            const histEl = document.getElementById('patientEditHistory'); if (histEl) histEl.innerHTML = ''; histEl.classList.add('hidden');
        }

        // Un-highlight previous selection and highlight current
        document.querySelectorAll('#uniquePatientList .nav-item').forEach(item => {
            if (item.textContent.includes(patientName)) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
        
        const patientData = allTransactions.filter(t => t.branch === currentBranch && t.patientName === patientName)
            .sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort newest first

        const lastTransaction = patientData.length > 0 ? patientData[0] : null;
        let phoneText = `Cell: ${lastTransaction ? lastTransaction.cellNumber : 'N/A'}`;
        let lastSeen = `Last Seen: ${lastTransaction ? lastTransaction.date : 'N/A'}`;

        // If we have a saved patient record, show address and prefer saved cell number
        if (savedPatient) {
            if (savedPatient.cellNumber) phoneText = `Cell: ${formatPhoneDisplay(savedPatient.cellNumber)}`;
            const addrEl = document.getElementById('patientCardAddress');
            addrEl.textContent = `Address: ${savedPatient.address || 'N/A'}`;
            addrEl.style.display = 'block';
        } else {
            const addrEl = document.getElementById('patientCardAddress');
            if (addrEl) addrEl.style.display = 'none';
        }

        document.getElementById('patientCardPhone').textContent = `${phoneText} | ${lastSeen}`;
        
        // Total balance
        const totalFee = patientData.reduce((sum, t) => sum + t.procedureFee, 0);
        const totalPaid = patientData.reduce((sum, t) => sum + t.amountPaid, 0);
        const outstandingBalance = totalFee - totalPaid;
        
        // NEW: Render History Table (treatments only, no billing amounts)
        const historyHtml = patientData.map(t => `
            <tr>
                <td>${t.date}</td>
                <td>${t.doctor}</td>
                <td>${t.procedure}</td>
                <td>${t.toothNumbers || 'N/A'} / Qty: ${t.quantity}</td>
                <td title="${t.treatmentNotes}">${t.treatmentNotes ? t.treatmentNotes.substring(0, 30) + (t.treatmentNotes.length > 30 ? '...' : '') : '-'}</td>
            </tr>
        `).join('');

        document.getElementById('patientHistoryTableBody').innerHTML = historyHtml;
        
        // Enable document button
        document.getElementById('previewBtn').disabled = false;
        document.getElementById('documentSelector').value = '';
        document.getElementById('documentPreviewArea').classList.add('hidden');
        
        // NEW: Render prescriptions for patient
        renderPrescriptionsList();
        
        // Render dental chart
        renderDentalChart(patientName);
    }

    // Start editing the currently selected patient by pre-filling the New Patient form
    function startEditPatient() {
        const btn = document.getElementById('editPatientBtn');
        if (!btn) return;
        const patientName = btn.dataset.patientName || selectedPatientName;
        if (!patientName) {
            showToast('No patient selected for editing.', 'error');
            return;
        }

        // Try find in allPatients
        const patient = (allPatients || []).find(p => `${p.firstName} ${p.surname}`.trim() === patientName);
            // Open the new patient tab for editing first (switchTab clears the form, so populate AFTER switching)
        switchTab('new-patient', document.querySelector('#patientManagementGroup [data-tab="new-patient"]'), 'üÜï New Patient');

        if (patient) {
            console.log('DEBUG: startEditPatient - patient found:', patient);
            // Populate form fields AFTER switching to avoid clearNewPatientForm wiping values
            const idEl = document.getElementById('newPatientId');
            const cellEl = document.getElementById('newPatientCell');
            const addrEl = document.getElementById('newPatientAddress');
            console.log('DEBUG: startEditPatient - elements:', !!idEl, !!cellEl, !!addrEl);
            if (idEl) idEl.value = patient.id;
            if (document.getElementById('newPatientFirstName')) document.getElementById('newPatientFirstName').value = patient.firstName;
            if (document.getElementById('newPatientSurname')) document.getElementById('newPatientSurname').value = patient.surname;
            // Format phone for display when editing
            if (cellEl) cellEl.value = formatPhoneDisplay(patient.cellNumber) || patient.cellNumber || '';
            if (document.getElementById('newPatientDOB')) document.getElementById('newPatientDOB').value = patient.dob || '';
            if (addrEl) addrEl.value = patient.address || '';
            console.log('DEBUG: startEditPatient - after populate id=', idEl && idEl.value, 'cell=', cellEl && cellEl.value, 'addr=', addrEl && addrEl.value);
        } else {
            console.log('DEBUG: startEditPatient - patient not found, prefill from name', patientName);
            // If patient not in allPatients, try to split name and pre-fill
            const parts = (patientName || '').split(' ');
            if (document.getElementById('newPatientFirstName')) document.getElementById('newPatientFirstName').value = parts.shift() || '';
            if (document.getElementById('newPatientSurname')) document.getElementById('newPatientSurname').value = parts.join(' ') || '';
            if (document.getElementById('newPatientCell')) document.getElementById('newPatientCell').value = '';
            if (document.getElementById('newPatientAddress')) document.getElementById('newPatientAddress').value = '';
            if (document.getElementById('newPatientId')) document.getElementById('newPatientId').value = '';
        }
    }

    // Delete patient with confirmation and provide an Undo action
    function deletePatient() {
        const btn = document.getElementById('deletePatientBtn');
        const patientName = (btn && btn.dataset && btn.dataset.patientName) ? btn.dataset.patientName : selectedPatientName;
        if (!patientName) { showToast('No patient selected.', 'error'); return; }

        if (!confirm(`Delete patient ${patientName}? This will remove the patient record.`)) return;

        const idx = (allPatients || []).findIndex(p => `${p.firstName} ${p.surname}`.trim() === patientName);
        if (idx === -1) { showToast('Patient record not found.', 'error'); return; }

        lastDeletedPatient = { patient: allPatients[idx], index: idx };
        allPatients.splice(idx, 1);
        saveData();
        renderPatientDatalist();
        // Clear UI selection
        selectedPatientName = null;
        document.getElementById('patientCardHeader').textContent = 'Select a Patient to View Details';
        document.getElementById('patientCardPhone').textContent = 'History and details will appear here.';
        const editBtn = document.getElementById('editPatientBtn'); if (editBtn) editBtn.style.display = 'none';
        const delBtn = document.getElementById('deletePatientBtn'); if (delBtn) delBtn.style.display = 'none';
        const histBtn = document.getElementById('toggleHistoryBtn'); if (histBtn) histBtn.style.display = 'none';
        const histEl = document.getElementById('patientEditHistory'); if (histEl) { histEl.innerHTML = ''; histEl.style.display = 'none'; }

        // Show toast with Undo button
        const container = document.getElementById('toastContainer') || (() => { const c=document.createElement('div'); c.id='toastContainer'; c.className='toast-container'; document.body.appendChild(c); return c; })();
        const toast = document.createElement('div'); toast.className = 'toast success';
        const msg = document.createElement('span'); msg.textContent = 'Patient deleted.';
        const undoBtn = document.createElement('button'); undoBtn.className = 'btn'; undoBtn.textContent = 'Undo'; undoBtn.style.marginLeft = '10px'; undoBtn.onclick = () => { undoDelete(); toast.remove(); };
        toast.appendChild(msg); toast.appendChild(undoBtn); container.appendChild(toast);

        if (lastDeletedTimeout) clearTimeout(lastDeletedTimeout);
        lastDeletedTimeout = setTimeout(() => { lastDeletedPatient = null; try{ toast.remove(); } catch(e){} }, 8000);
    }

    function undoDelete() {
        if (!lastDeletedPatient) { showToast('Nothing to undo.', 'error'); return; }
        const idx = lastDeletedPatient.index;
        allPatients.splice(idx, 0, lastDeletedPatient.patient);
        saveData();
        renderPatientDatalist();
        showToast('Delete undone.');
        lastDeletedPatient = null;
        if (lastDeletedTimeout) { clearTimeout(lastDeletedTimeout); lastDeletedTimeout = null; }
    }

    function togglePatientHistory() {
        const histEl = document.getElementById('patientEditHistory');
        if (!histEl) return;
        const isVisible = histEl.style.display === 'block' || histEl.classList.contains('open');
        histEl.style.display = isVisible ? 'none' : 'block';
    }

    function renderPatientEditHistory(patient) {
        const histEl = document.getElementById('patientEditHistory');
        if (!histEl) return;
        const edits = (patient && patient.edits) ? patient.edits.slice().reverse() : [];
        if (!edits.length) {
            histEl.innerHTML = '<div style="color:#94a3b8;">No edit history for this patient.</div>';
            histEl.style.display = 'none';
            return;
        }
        let html = '<div style="font-weight:700; margin-bottom:8px;">Edit History</div>';
        html += '<ul style="padding-left: 18px; margin:0;">';
        edits.forEach(e => {
            const when = new Date(e.at).toLocaleString();
            const who = e.changedBy || 'System';
            html += `<li style="margin-bottom:6px;"><div style="font-size:13px; color:#cbd5e1;">${when} ‚Äî ${who}</div>`;
            html += `<div style="font-size:13px; color:#94a3b8;">${e.prev.firstName} ${e.prev.surname} | ${e.prev.cellNumber || 'No cell'} | ${e.prev.address || ''}</div></li>`;
        });
        html += '</ul>';
        histEl.innerHTML = html;
        histEl.style.display = 'none';
    }

    function handleDocumentSelection(docType) {
        document.getElementById('previewBtn').disabled = !docType;
        document.getElementById('documentPreviewArea').classList.add('hidden');
        

    }

    function previewDocument() {
        if (!selectedPatientName) {
            alert('Please select a patient first.');
            return;
        }

        const docType = document.getElementById('documentSelector').value;
        const patientData = allTransactions.filter(t => t.branch === currentBranch && t.patientName === selectedPatientName)
            .sort((a, b) => new Date(b.date) - new Date(a.date));

        let docContent = '';

        if (docType === 'history') {
            docContent = `FULL TREATMENT HISTORY FOR: ${selectedPatientName}\n\n`;
            
            patientData.forEach(t => {
                docContent += `Date: ${t.date}\n`;
                docContent += `Doctor: ${t.doctor}\n`;
                docContent += `Procedure: ${t.procedure} (Tooth: ${t.toothNumbers || 'N/A'} / Qty: ${t.quantity})\n`;
                docContent += `Fee: ${formatCurrency(t.procedureFee)} | Paid: ${formatCurrency(t.amountPaid)} | Balance: ${formatCurrency(t.balance)}\n`;
                docContent += `Notes: ${t.treatmentNotes || 'N/A'}\n`;
                docContent += `----------------------------------------\n`;
            });

        } else if (docType === 'statement') {
            const totalFee = patientData.reduce((sum, t) => sum + t.procedureFee, 0);
            const totalPaid = patientData.reduce((sum, t) => sum + t.amountPaid, 0);
            const outstandingBalance = totalFee - totalPaid;
            
            docContent = `MAISHA DENTAL CLINICS - ACCOUNT STATEMENT\n\n`;
            docContent += `Patient: ${selectedPatientName}\n`;
            docContent += `Date: ${todayDateString()}\n\n`;
            
            docContent += `Summary of Charges and Payments:\n`;
            patientData.forEach(t => {
                docContent += `- ${t.date}: ${t.procedure} (${t.toothNumbers || 'N/A'}) - Charge: ${formatCurrency(t.procedureFee)}, Paid: ${formatCurrency(t.amountPaid)}\n`;
            });
            
            docContent += `\n========================================\n`;
            docContent += `TOTAL CHARGED: ${formatCurrency(totalFee)}\n`;
            docContent += `TOTAL PAID: ${formatCurrency(totalPaid)}\n`;
            docContent += `OUTSTANDING BALANCE: ${formatCurrency(outstandingBalance)}\n`;
            docContent += `========================================\n`;

        } else if (docType === 'medical-certificate') {
            if (currentUser.role !== 'Doctor') {
                docContent = 'ACCESS DENIED: Only Doctors can generate Medical Certificates.';
            } else {
                docContent = `MAISHA DENTAL CLINICS - MEDICAL CERTIFICATE\n\n`;
                docContent += `${CLINIC_STATION_MEDICAL_ADDRESS}\n\n`;
                const certDoctor = getDoctorDisplay(currentUser.doctorName);
                docContent += `To Whom It May Concern:\n\n`;
                docContent += `This certifies that ${selectedPatientName} was examined/treated by ${certDoctor} at the ${currentBranch} branch on ${todayDateString()}.\n\n`;
                docContent += `The patient is advised to be absent from work/school for [X] days.\n\n`;
                docContent += `(This is a template. A real certificate should be signed by the Doctor.)`;
        }
    }

        document.getElementById('documentPreviewArea').textContent = docContent;
        document.getElementById('documentPreviewArea').classList.remove('hidden');
    }

    // NEW: Add a prescription for the selected patient
    function updatePrescriptionDefaults() {
        const name = (document.getElementById('prescriptionMedicationName').value || '').toLowerCase();
        const dosageSelect = document.getElementById('prescriptionDosage');
        const frequencySelect = document.getElementById('prescriptionFrequency');
        const hintEl = document.getElementById('pediatricDosageHint');
        if (!dosageSelect || !frequencySelect) return;
        hintEl && (hintEl.textContent = 'Pediatric guidance will appear here when applicable.');
        // Default mappings
        if (name.includes('amox') || name.includes('amoxicillin') || name.includes('amoxil')) {
            dosageSelect.value = '500mg';
            frequencySelect.value = 'Three times a day';
            hintEl && (hintEl.textContent = 'Adults: 250‚Äì500mg, 1 cap 3 times daily. Children dosing based on weight.');
        } else if (name.includes('metron') || name.includes('metronido')) {
            dosageSelect.value = '200mg';
            frequencySelect.value = 'Three times a day';
            hintEl && (hintEl.textContent = 'Adults: 200‚Äì400mg three times daily. Children (7‚Äì10 y): ~7.5 mg/kg every 8 hrs or 100 mg three times daily.');
        } else if (name.includes('brufen') || name.includes('ibuprofen')) {
            dosageSelect.value = '400mg_brufen';
            frequencySelect.value = 'Three times a day';
            hintEl && (hintEl.textContent = 'Adults: 200‚Äì400mg three times daily. For children follow pediatric syrup dosages.');
        } else if (name.includes('erythro') || name.includes('erythromycin')) {
            dosageSelect.value = '500mg_ery';
            frequencySelect.value = 'Four times daily';
            hintEl && (hintEl.textContent = 'Erythromycin: Adults 250‚Äì500mg capsules 1‚Äì2 caps 4 times daily. For children use suspension 125mg/5ml or 250mg/5ml dosing by weight.');
        } else if (name.includes('panado') || name.includes('paracetamol')) {
            dosageSelect.value = '500mg';
            frequencySelect.value = 'Three times a day';
            hintEl && (hintEl.textContent = 'Paracetamol: Adults 500mg 1‚Äì2 tabs up to 8 tabs/24hrs. Pediatric syrup dosing: 120mg/5ml; see guideline per age.');
        } else {
            // no change
        }
        // Update computed pediatric dose if weight/patient known
        computePediatricDose();
    }

    function computePediatricDose() {
        const med = (document.getElementById('prescriptionMedicationName')?.value || '').toLowerCase();
        const weightVal = parseFloat(document.getElementById('prescriptionPatientWeight')?.value || '0');
        const hintEl = document.getElementById('pediatricDosageHint');
        const tableEl = document.getElementById('pediatricDosageTable');
        if (!med || !weightVal || weightVal <= 0) {
            if (tableEl) tableEl.style.display = 'none';
            return;
        }
        // Compute drug-specific ranges
        let perDoseLow = 0, perDoseHigh = 0, perDoseTxt = '';
        if (med.includes('amox') || med.includes('amoxicillin')) {
            // 20-40 mg/kg/day divided TID
            perDoseLow = Math.round(weightVal * (20 / 3));
            perDoseHigh = Math.round(weightVal * (40 / 3));
            perDoseTxt = `${perDoseLow} - ${perDoseHigh} mg per dose (TID)`;
        } else if (med.includes('metron') || med.includes('metronido')) {
            // 7.5 mg/kg every 8 hrs
            perDoseLow = Math.round(weightVal * 7.5);
            perDoseHigh = perDoseLow;
            perDoseTxt = `${perDoseLow} mg per dose (every 8 hrs)`;
        } else if (med.includes('brufen') || med.includes('ibuprofen')) {
            // 5-10 mg/kg per dose
            perDoseLow = Math.round(weightVal * 5);
            perDoseHigh = Math.round(weightVal * 10);
            perDoseTxt = `${perDoseLow} - ${perDoseHigh} mg per dose (every 6-8 hrs)`;
        } else if (med.includes('erythro') || med.includes('erythromycin')) {
            // 30-50 mg/kg/day divided QID
            perDoseLow = Math.round(weightVal * (30 / 4));
            perDoseHigh = Math.round(weightVal * (50 / 4));
            perDoseTxt = `${perDoseLow} - ${perDoseHigh} mg per dose (QID)`;
        } else if (med.includes('paracetamol') || med.includes('panado')) {
            // 10-15 mg/kg per dose
            perDoseLow = Math.round(weightVal * 10);
            perDoseHigh = Math.round(weightVal * 15);
            perDoseTxt = `${perDoseLow} - ${perDoseHigh} mg per dose (every 4-6 hrs)`;
        } else {
            // unknown med
            perDoseTxt = '';
        }

        if (!perDoseTxt) { if (tableEl) tableEl.style.display = 'none'; return; }

        // If suspension selected, attempt to convert to ml per dose if possible
        let volumeTxt = '';
        const dosageSel = (document.getElementById('prescriptionDosage')?.value || '').toLowerCase();
        if (dosageSel.includes('mg/5ml')) {
            const mgPer5ml = parseFloat(dosageSel.split('mg')[0]) || 0;
            if (mgPer5ml > 0) {
                const mgPerMl = mgPer5ml / 5;
                const lowMl = Math.round((perDoseLow / mgPerMl) * 10) / 10;
                const highMl = Math.round((perDoseHigh / mgPerMl) * 10) / 10;
                volumeTxt = ` ‚âà ${lowMl} - ${highMl} ml per dose (susp)`;
            }
        }

        if (tableEl) {
            tableEl.style.display = 'block';
            tableEl.textContent = `Pediatric recommendation: ${perDoseTxt}${volumeTxt ? ' ' + volumeTxt : ''}`;
        }
    }

    function addPrescription() {
        if (!selectedPatientName) {
            showToast('Please select a patient first.', 'error');
            return;
        }
        
        const medName = (document.getElementById('prescriptionMedicationName').value || '').trim();
        const rawDosage = (document.getElementById('prescriptionDosage').value || '').trim();
        const dosage = rawDosage.split('_')[0];
        const frequency = (document.getElementById('prescriptionFrequency').value || '').trim();
        const duration = (document.getElementById('prescriptionDuration').value || '').trim();
        const instructions = (document.getElementById('prescriptionInstructions').value || '').trim();
        
        if (!medName || !dosage || !frequency || !duration) {
            showToast('Please fill in Medication Name, Dosage, Frequency, and Duration.', 'error');
            return;
        }
        
        const prescription = {
            id: Date.now(),
            patientName: selectedPatientName,
            medicationName: medName,
            dosage: dosage,
            frequency: frequency,
            duration: duration,
            specialInstructions: instructions,
            prescribedBy: (currentUser && currentUser.doctorName) ? currentUser.doctorName : 'Doctor',
            prescribedDate: new Date().toISOString()
        };
        
        allPrescriptions.push(prescription);
        saveData();
        
        // Clear form
        document.getElementById('prescriptionMedicationName').value = '';
        document.getElementById('prescriptionDosage').value = '';
        document.getElementById('prescriptionFrequency').value = '';
        document.getElementById('prescriptionDuration').value = '';
        document.getElementById('prescriptionInstructions').value = '';
        
        renderPrescriptionsList();
        showToast(`Prescription added for ${medName}`);
    }

    // NEW: Render list of prescriptions for selected patient
    function renderPrescriptionsList() {
        const container = document.getElementById('prescriptionListContainer');
        if (!container || !selectedPatientName) return;
        
        const patientPrescriptions = (allPrescriptions || []).filter(p => p.patientName === selectedPatientName);
        
        if (patientPrescriptions.length === 0) {
            container.innerHTML = '<div style="color: #94a3b8; font-size: 12px;">No prescriptions yet.</div>';
            return;
        }
        
        container.innerHTML = patientPrescriptions.map((rx, idx) => `
            <div class="content-card" style="padding: 12px; margin-bottom: 10px; border-left: 3px solid #60a5fa;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <div style="font-weight: 700; color: #60a5fa;">üíä ${escapeHtml(rx.medicationName)}</div>
                    <button class="btn" style="padding: 4px 8px; font-size: 11px;" onclick="deletePrescription(${rx.id})">üóëÔ∏è</button>
                </div>
                <div style="color: #e2e8f0; font-size: 12px; margin-bottom: 6px;">
                    <strong>Dosage:</strong> ${escapeHtml(rx.dosage)} | <strong>Frequency:</strong> ${escapeHtml(rx.frequency)} | <strong>Duration:</strong> ${escapeHtml(rx.duration)}
                </div>
                <div style="color: #94a3b8; font-size: 11px; margin-bottom: 4px;">
                    Prescribed by: ${escapeHtml(rx.prescribedBy)} on ${new Date(rx.prescribedDate).toLocaleDateString()}
                </div>
                ${rx.specialInstructions ? `<div style="color: #cbd5e1; font-size: 11px; font-style: italic;">Instructions: ${escapeHtml(rx.specialInstructions)}</div>` : ''}
            </div>
        `).join('');
    }

    // NEW: Preview prescription for download
    function previewPrescription() {
        if (!selectedPatientName) {
            showToast('Please select a patient first.', 'error');
            return;
        }
        
        const patientPrescriptions = (allPrescriptions || []).filter(p => p.patientName === selectedPatientName);
        if (patientPrescriptions.length === 0) {
            showToast('No prescriptions to preview.', 'error');
            return;
        }
        
        let content = `MAISHA DENTAL CLINICS\n`;
        content += `Branch: ${currentBranch || 'N/A'}\n`;
        content += `Date: ${todayDateString()}\n`;
        content += `${'='.repeat(50)}\n\n`;
        
        content += `PATIENT INFORMATION:\n`;
        content += `Name: ${escapeHtml(selectedPatientName)}\n`;
        content += `Date: ${todayDateString()}\n\n`;
        
        content += `PRESCRIPTIONS:\n`;
        content += `${'='.repeat(50)}\n\n`;
        
        patientPrescriptions.forEach((rx, idx) => {
            // Compact format: MEDICATION dosage frequency duration
            const freqShort = rx.frequency
                .replace('Three times a day', '1tds')
                .replace('Twice daily', '1bd')
                .replace('Once daily', '1od')
                .replace('Four times daily', '1qid')
                .replace('Every 8 hrs', '1q8h');
            const durationShort = rx.duration
                .replace('days', 'd')
                .replace('weeks', 'w')
                .replace('day', 'd')
                .replace('week', 'w')
                .replace(/\s+/g, '');
            content += `${idx + 1}. MEDICATION: ${rx.medicationName} ${rx.dosage} ${freqShort} ${durationShort}\n`;
            if (rx.specialInstructions) {
                content += `   Special Instructions: ${rx.specialInstructions}\n`;
            }
        });
        
        content += `\n${'='.repeat(50)}\n`;
        const prescriber = (currentUser && currentUser.doctorName) ? getDoctorDisplay(currentUser.doctorName) : getDoctorDisplay('M. Mokoma');
        content += `Prescribed by: ${prescriber}\n`;
        
        // Show in preview area and auto-download
        const previewArea = document.getElementById('documentPreviewArea');
        if (previewArea) {
            previewArea.textContent = content;
            previewArea.classList.remove('hidden');
            // Auto-trigger download
            downloadPrescription();
        }
    }

    function downloadPrescription() {
        if (!selectedPatientName) {
            showToast('Please select a patient first.', 'error');
            return;
        }
        
        const patientPrescriptions = (allPrescriptions || []).filter(p => p.patientName === selectedPatientName);
        if (patientPrescriptions.length === 0) {
            showToast('No prescriptions to download.', 'error');
            return;
        }
        
        let content = `MAISHA DENTAL CLINICS\n`;
        content += `Branch: ${currentBranch || 'N/A'}\n`;
        content += `Date: ${todayDateString()}\n`;
        content += `${'='.repeat(50)}\n\n`;
        
        content += `PATIENT INFORMATION:\n`;
        content += `Name: ${selectedPatientName}\n`;
        content += `Date: ${todayDateString()}\n\n`;
        
        content += `PRESCRIPTIONS:\n`;
        content += `${'='.repeat(50)}\n\n`;
        
        patientPrescriptions.forEach((rx, idx) => {
            // Compact format: MEDICATION dosage frequency duration
            const freqShort = rx.frequency
                .replace('Three times a day', '1tds')
                .replace('Twice daily', '1bd')
                .replace('Once daily', '1od')
                .replace('Four times daily', '1qid')
                .replace('Every 8 hrs', '1q8h');
            const durationShort = rx.duration
                .replace('days', 'd')
                .replace('weeks', 'w')
                .replace('day', 'd')
                .replace('week', 'w')
                .replace(/\s+/g, '');
            content += `${idx + 1}. MEDICATION: ${rx.medicationName} ${rx.dosage} ${freqShort} ${durationShort}\n`;
            if (rx.specialInstructions) {
                content += `   Special Instructions: ${rx.specialInstructions}\n`;
            }
        });
        
        content += `\n${'='.repeat(50)}\n`;
        const prescriber = (currentUser && currentUser.doctorName) ? getDoctorDisplay(currentUser.doctorName) : getDoctorDisplay('M. Mokoma');
        content += `Prescribed by: ${prescriber}\n`;
        
        // Create blob and download
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `Prescription_${selectedPatientName.replace(/\s+/g, '_')}_${Date.now()}.txt`;
        document.body.appendChild(link);
        try { link.click(); } catch (e) { console.debug('downloadPrescription: not supported in headless'); }
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showToast('Prescription downloaded successfully!');
    }

    function printPrescription() {
        // Populate preview then call print
        previewPrescription();
        try { window.print(); } catch (e) { console.debug('printPrescription: print not supported'); }
    }

    // NEW: Delete a prescription
    function deletePrescription(prescriptionId) {
        const idx = allPrescriptions.findIndex(p => p.id === prescriptionId);
        if (idx === -1) {
            showToast('Prescription not found.', 'error');
            return;
        }
        
        const medName = allPrescriptions[idx].medicationName;
        allPrescriptions.splice(idx, 1);
        saveData();
        renderPrescriptionsList();
        showToast(`Prescription for ${medName} deleted.`);
    }

    // Quick-prescription checkbox UI removed; no update function necessary.

    // Quick-prescription checkbox UI removed; batch add helper deleted in favor of explicit medication selection.

    // Quick-prescription checkbox UI removed; clear helper deleted.

    // --- DENTAL CHART FUNCTIONS ---
    function switchChartTab(tabId, element) {
        document.querySelectorAll('.chart-tab-btn').forEach(btn => btn.classList.remove('active'));
        element.classList.add('active');
        document.querySelectorAll('.chart-tab-content').forEach(content => content.classList.add('hidden'));
        document.getElementById(`chart-tab-${tabId}`).classList.remove('hidden');
    }

    function selectTooth(toothNum) {
        if (!selectedPatientName) {
            alert('Please select a patient first.');
            return;
        }

        selectedTooth = toothNum;
        switchChartTab('details', document.querySelector('.chart-tab-btn:nth-child(2)'));
        
        const patientChartKey = `${currentBranch}_${selectedPatientName}`;
        const status = dentalChartStatus[patientChartKey]?.[toothNum] || { status: '', notes: '' };

        document.getElementById('selectedToothHeader').textContent = `Selected Tooth: ${toothNum}`;
        document.getElementById('toothStatus').value = status.status;
        document.getElementById('toothNotes').value = status.notes;

        // Only allow doctors to modify the status
        if (currentUser.role === 'Doctor') {
            document.getElementById('toothModificationForm').classList.remove('hidden');
            document.getElementById('toothDetailsContent').innerHTML = ''; // Clear fallback message
        } else {
            document.getElementById('toothModificationForm').classList.add('hidden');
            document.getElementById('toothDetailsContent').innerHTML = `
                <p style="color: #94a3b8; margin-bottom: 10px;">Current Status: 
                    <span style="font-weight: bold; color: #f1f5f9;">${status.status || 'No Status Logged'}</span>
                </p>
                <p style="color: #94a3b8;">Notes: ${status.notes || 'N/A'}</p>
            `;
        }
    }

    function saveToothStatus() {
        if (!selectedPatientName || !selectedTooth) return;

        const status = document.getElementById('toothStatus').value;
        const notes = document.getElementById('toothNotes').value.trim();
        
        if (currentUser.role !== 'Doctor') {
            alert('Only a Doctor can modify tooth status.');
            return;
        }

        const patientChartKey = `${currentBranch}_${selectedPatientName}`;
        
        // Initialize the patient's chart entry if it doesn't exist
        if (!dentalChartStatus[patientChartKey]) {
            dentalChartStatus[patientChartKey] = {};
        }

        // Save the new status
        dentalChartStatus[patientChartKey][selectedTooth] = { status, notes };
        saveData();
        
        alert(`Status for Tooth ${selectedTooth} saved.`);
        renderDentalChart(selectedPatientName); // Re-render the chart visualization
        
        // Reload details view for immediate feedback
        selectTooth(selectedTooth); 
    }

    function renderDentalChart(patientName) {
        const patientChartKey = `${currentBranch}_${patientName}`;
        const chartData = dentalChartStatus[patientChartKey] || {};

        document.querySelectorAll('.tooth-item').forEach(item => {
            const toothNum = item.textContent.trim().replace(/[^0-9]/g, '');
            const statusDiv = item.querySelector('.tooth-status');
            
            // Reset to default (no status)
            statusDiv.classList.add('hidden');
            statusDiv.textContent = 'X';
            item.style.backgroundColor = 'transparent';
            item.style.color = '#f1f5f9';

            const status = chartData[toothNum];
            if (status && status.status) {
                statusDiv.classList.remove('hidden');
                let statusChar = '?';
                let bgColor = '#60a5fa'; // Default to blue
                
                if (status.status === 'Missing') {
                    statusChar = 'X';
                    bgColor = '#ef4444'; // Red for missing
                } else if (status.status === 'Carious') {
                    statusChar = 'C';
                    bgColor = '#facc15'; // Yellow/Gold for carious
                } else if (status.status === 'Filled' || status.status === 'Crown' || status.status === 'Root Canal') {
                    statusChar = 'F';
                    bgColor = '#10b981'; // Green for treated
                }
                
                statusDiv.textContent = statusChar;
                statusDiv.style.backgroundColor = bgColor;
                
                // Set a slight background color tint for the tooth item itself
                // Darken the color a bit for the background
                let bgTint = '#334155'; // Default subtle gray
                if (bgColor === '#ef4444') bgTint = '#451717';
                if (bgColor === '#facc15') bgTint = '#42330f';
                if (bgColor === '#10b981') bgTint = '#17362f';
                if (bgColor === '#60a5fa') bgTint = '#1d273a'; 
                
                item.style.backgroundColor = bgTint;
            }
        });
    }


    // --- APPOINTMENTS ---
    function addAppointment() {
        const date = document.getElementById('apptDate').value;
        const time = document.getElementById('apptTime').value;
        const doctor = document.getElementById('apptDoctor').value;
        const patientName = document.getElementById('apptPatientName').value.trim();
        const cellNumber = document.getElementById('apptCellNumber').value.trim();
        const notes = document.getElementById('apptNotes').value.trim();

        if (!date || !time || !doctor || !patientName) {
            alert('Please fill in Date, Time, Doctor, and Patient Name.');
            return;
        }

        allAppointments.push({
            id: Date.now(),
            branch: currentBranch,
            date,
            time,
            doctor,
            patientName,
            cellNumber,
            notes,
            attended: false
        });
        saveData();
        alert(`Appointment for ${patientName} scheduled for ${date} at ${time}.`);

        // Reset form (keep date and doctor)
        document.getElementById('apptTime').value = '';
        document.getElementById('apptPatientName').value = '';
        document.getElementById('apptCellNumber').value = '';
        document.getElementById('apptNotes').value = '';
        renderAppointments();
    }

    function renderAppointments() {
        const dateFilter = document.getElementById('apptDate').value || todayDateString();
        const doctorFilter = document.getElementById('apptDoctor').value;

        const filteredAppointments = allAppointments.filter(a => 
            a.branch === currentBranch && a.date === dateFilter && a.doctor === doctorFilter
        ).sort((a, b) => a.time.localeCompare(b.time));

        const tableBody = document.getElementById('appointmentsTableBody');
        if (filteredAppointments.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #94a3b8;">No appointments scheduled for Dr. ${doctorFilter} on ${dateFilter}.</td></tr>`;
            return;
        }
        
        const canEdit = currentUser.role === 'Admin' || currentUser.role === 'Assistance';
        const canDelete = currentUser.role === 'Admin' || currentUser.role === 'Doctor';


        tableBody.innerHTML = filteredAppointments.map(a => {
            const attendedCheckbox = `<input type="checkbox" ${canEdit ? '' : 'disabled'} ${a.attended ? 'checked' : ''} onchange="toggleAppointmentAttendance(${a.id}, this.checked)">`;
            const deleteButton = canDelete ? `<button class="action-btn delete-btn" onclick="deleteAppointment(${a.id})">üóëÔ∏è Delete</button>` : 'üîí';
            const actionHtml = canDelete ? deleteButton : 'üîí';
            
            return `
                <tr>
                    <td>${a.time}</td>
                    <td>${a.patientName}</td>
                    <td>${a.cellNumber || '-'}</td>
                    <td>${a.doctor}</td>
                    <td>${a.notes || '-'}</td>
                    <td class="attended-col">${attendedCheckbox}</td>
                    <td>${actionHtml}</td>
                </tr>
            `;
        }).join('');
    }

    function toggleAppointmentAttendance(id, isChecked) {
        if (currentUser.role !== 'Admin' && currentUser.role !== 'Assistance') {
            alert('You do not have permission to mark attendance.');
            renderAppointments(); // Revert checkbox state
            return;
        }

        const appt = allAppointments.find(a => a.id === id);
        if (appt) {
            appt.attended = isChecked;
            saveData();
            // Optional: re-render to update the row style/status if applicable
            // For now, just renderAppointments() if needed, but the checkbox state updates live.
        }
    }

    function deleteAppointment(id) {
        if (!confirm('Are you sure you want to delete this appointment?')) return;

        const apptIndex = allAppointments.findIndex(a => a.id === id);
        if (apptIndex !== -1) {
            const appt = allAppointments[apptIndex];
            const canDelete = currentUser.role === 'Admin' || (currentUser.role === 'Doctor' && currentUser.doctorName === appt.doctor);

            if (!canDelete) {
                 alert('You do not have permission to delete this appointment.');
                 return;
            }

            allAppointments.splice(apptIndex, 1);
            saveData();
            renderAppointments();
        }
    }

    // --- STOCK MANAGEMENT ---
    function switchStockTab(tabId, element) {
        document.querySelectorAll('.stock-tab-btn').forEach(btn => btn.classList.remove('active'));
        element.classList.add('active');
        document.querySelectorAll('.stock-tab-content').forEach(content => content.classList.add('hidden'));
        document.getElementById(`stock-${tabId}-section`).classList.remove('hidden');

        if (tabId === 'items') {
            renderStockInventory();
        } else if (tabId === 'log') {
            renderStockLog();
        }
    }

    function logStockMovement() {
        const date = document.getElementById('stockDate').value || todayDateString();
        const itemName = document.getElementById('stockItemName').value.trim();
        const type = document.getElementById('stockType').value;
        const quantity = parseInt(document.getElementById('stockQuantity').value) || 0;
        const totalCost = parseFloat(document.getElementById('stockTotalCost').value) || 0;
        const notes = document.getElementById('stockNotes').value.trim();

        if (!itemName || quantity <= 0) {
            alert('Please enter Item Name and a valid Quantity > 0.');
            return;
        }

        if (type === 'In' && totalCost <= 0) {
            if (!confirm('You are logging Stock In with no Total Cost. Is this correct?')) return;
        }

        allStockLog.push({
            id: Date.now(),
            branch: currentBranch,
            date,
            itemName,
            type,
            quantity: type === 'Out' ? -quantity : quantity, // Store Out as negative for easy summation
            totalCost: type === 'Out' ? 0 : totalCost,
            notes
        });
        saveData();
        alert(`Stock movement of ${quantity} ${itemName} logged successfully.`);

        // Reset form (keep date)
        document.getElementById('stockItemName').value = '';
        document.getElementById('stockQuantity').value = '';
        document.getElementById('stockTotalCost').value = '';
        document.getElementById('stockNotes').value = '';

        if (document.querySelector('.stock-tab-btn[onclick*="items"]').classList.contains('active')) {
            renderStockInventory();
        }
        if (document.querySelector('.stock-tab-btn[onclick*="log"]').classList.contains('active')) {
            renderStockLog();
        }
    }

    function renderStockInventory() {
        const branchLogs = allStockLog.filter(l => l.branch === currentBranch);
        
        // 1. Group by item name and calculate current quantity
        const inventoryMap = new Map();
        const lastMovementMap = new Map();
        
        branchLogs.forEach(l => {
            const name = l.itemName.trim();
            const currentQty = inventoryMap.get(name) || 0;
            inventoryMap.set(name, currentQty + l.quantity);
            lastMovementMap.set(name, l.date); // Keep track of the last movement date
        });

        const inventoryList = [];
        inventoryMap.forEach((quantity, itemName) => {
            if (quantity !== 0) { // Only show items with non-zero stock
                 inventoryList.push({
                    itemName,
                    quantity,
                    lastMoved: lastMovementMap.get(itemName)
                 });
            }
        });
        
        // Sort alphabetically
        inventoryList.sort((a, b) => a.itemName.localeCompare(b.itemName));
        
        const listContainer = document.getElementById('stockInventoryList');
        if (inventoryList.length === 0) {
            listContainer.innerHTML = `<p style="text-align: center; color: #94a3b8;">No stock recorded for this branch.</p>`;
            return;
        }
        
        let outputHtml = '<div>';
        inventoryList.forEach(item => {
            const qtyStyle = item.quantity > 5 ? 'color: #10b981;' : (item.quantity > 0 ? 'color: #facc15;' : 'color: #ef4444;');
            outputHtml += `
                 <div class="stock-item">
                     <div class="stock-item-name">${item.itemName} (Last logged: ${item.lastMoved})</div>
                     <div class="stock-item-qty" style="${qtyStyle}">Qty: ${item.quantity}</div>
                 </div>
             `;
        });
        outputHtml += '</div>';
        listContainer.innerHTML = outputHtml;
    }

    function renderStockLog() {
        const branchLogs = allStockLog.filter(l => l.branch === currentBranch).sort((a, b) => new Date(b.date) - new Date(a.date));
        const tableBody = document.getElementById('stockLogTableBody');

        if (branchLogs.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #94a3b8;">No stock movement logged.</td></tr>';
            return;
        }
        
        tableBody.innerHTML = branchLogs.map(l => {
            const qtyText = l.type === 'Out' ? Math.abs(l.quantity) : l.quantity; // Show quantity as positive number
            const qtyStyle = l.type === 'In' ? 'color: #10b981;' : 'color: #ef4444;';
            
            return `
                <tr>
                    <td>${l.date}</td>
                    <td>${l.itemName}</td>
                    <td>${l.type}</td>
                    <td style="${qtyStyle}">${qtyText}</td>
                    <td>${formatCurrency(l.totalCost)}</td>
                    <td>${l.notes || '-'}</td>
                </tr>
            `;
        }).join('');
    }

    // --- INITIALIZATION ---
    loadData();
    
    // Attach click handlers for dental chart
    document.addEventListener('DOMContentLoaded', () => {
        // Simple text contains function (for demonstration)
        if (!String.prototype.includes) {
            String.prototype.includes = function(search, start) {
                if (typeof start !== 'number') start = 0;
                if (start + search.length > this.length) return false;
                return this.indexOf(search, start) !== -1;
            };
        }
        
        // Attach onclick to all tooth items
        document.querySelectorAll('.tooth-item').forEach(item => {
            item.onclick = function() {
                selectTooth(this.textContent.trim().replace(/[^0-9]/g, '')); // Select only the number
            };
        });
        
        // Set up the change listener for the procedure field
        document.getElementById('procedure').onchange = updateProcedureFee;
        
        // --- ADDED NEW EVENT LISTENERS ---
        // 1. Attach listener for patient name input for autofill (Request 1)
        const patientNameInput = document.getElementById('patientName');
        if (patientNameInput) {
            // Use 'input' event to check for changes as the user types or selects from the list
            patientNameInput.addEventListener('input', (event) => {
                autofillPatientDetails(event.target.value);
            });
        }
        
        // 2. Attach listener for locum payment doctor selection to autofill amount (Request 3)
        const locumPaymentDoctorSelect = document.getElementById('locumPaymentDoctor');
        if (locumPaymentDoctorSelect) {
            locumPaymentDoctorSelect.addEventListener('change', populateLocumPaymentAmount);
        }
        // --- END ADDED NEW EVENT LISTENERS ---

        // Set default dates
        document.getElementById('date').value = todayDateString();
        document.getElementById('expenseDate').value = todayDateString();
        document.getElementById('apptDate').value = todayDateString();
        document.getElementById('stockDate').value = todayDateString();
        
    });

  </script>
</body>
</html>
